<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hedy's TastenZauber</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
         /* ... (Gleiches CSS wie immer) ... */
         /* Nur eine winzige Erg√§nzung f√ºr den Highscore im Men√º falls n√∂tig, aber Standard-CSS reicht */
        :root { --primary: #FF9AA2; --secondary: #B5EAD7; --accent: #FFB7B2; --text: #6d5c6d; --dark: #4A404F; --keyboard-bg: rgba(255, 255, 255, 0.85); --key-bg: #fff; --key-active: #C7CEEA; --key-error: #FFF176; --btn-inactive: #e0e0e0; --gold: #FFD700; }
        body { margin: 0; overflow: hidden; font-family: 'Fredoka', sans-serif; background-color: #E2F0CB; color: var(--text); user-select: none; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; transition: filter 0.3s; }
        #global-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 90; background: linear-gradient(120deg, #FF9AA2, #FFB7B2, #FFDAC1, #E2F0CB, #B5EAD7, #C7CEEA); background-size: 400% 400%; animation: rainbowBG 15s ease infinite; pointer-events: none; transition: filter 0.5s; }
        @keyframes rainbowBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .rainbow-spin { animation: rainbowSpin 1s linear infinite !important; filter: hue-rotate(90deg) contrast(1.5); }
        @keyframes rainbowSpin { 0% { background-position: 0% 50%; } 100% { background-position: 400% 50%; } }
        #bg-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.4; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        .ui-element { pointer-events: auto; }
        header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.3); backdrop-filter: blur(5px); }
        .header-left, .header-right { display: flex; gap: 10px; align-items: center; }
        .vol-control { display: flex; flex-direction: column; align-items: center; margin-right: 10px; }
        .vol-control input { width: 80px; cursor: pointer; }
        .vol-control span { font-size: 0.8rem; font-weight: bold; }
        .score-box { background: white; padding: 5px 15px; border-radius: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 1.1rem; font-weight: 600; display: flex; gap: 10px; align-items: center; }
        .progress-container { width: 200px; height: 15px; background: rgba(200,200,200,0.3); border-radius: 10px; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #FF9AA2, #FFB7B2); width: 0%; transition: width 0.2s; }
        #target-display { position: absolute; top: 15%; left: 50%; transform: translate(-50%, 0); text-align: center; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        #current-char { order: 1; font-size: 10rem; color: white; text-shadow: 0 4px 15px rgba(0,0,0,0.2); font-weight: bold; line-height: 1; animation: float 3s ease-in-out infinite; }
        .char-appear { animation: popInChar 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards !important; }
        @keyframes popInChar { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .particle { position: absolute; width: 10px; height: 10px; border-radius: 50%; pointer-events: none; z-index: 100; }
        .particle.star { clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); background: gold; }
        #next-chars { order: 2; font-size: 2rem; color: rgba(255,255,255,0.9); letter-spacing: 5px; background: rgba(0, 0, 0, 0.2); padding: 5px 20px; border-radius: 20px; backdrop-filter: blur(2px); }
        #keyboard-wrapper { margin-bottom: 30px; display: flex; justify-content: center; width: 100%; }
        .keyboard { background: var(--keyboard-bg); padding: 20px; border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); backdrop-filter: blur(5px); display: flex; flex-direction: column; gap: 8px; width: 950px; transition: width 0.3s; }
        .keyboard.macbook { width: 1100px; } 
        .row { display: flex; justify-content: center; gap: 8px; }
        .key { width: 52px; height: 52px; background: var(--key-bg); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 0 #ddd; color: var(--dark); transition: all 0.1s; position: relative; }
        .key.wide { width: 80px; } .key.space { width: 350px; } .key.cmd { width: 70px; font-size: 0.9rem; }
        .key.active { background: var(--primary) !important; color: white !important; box-shadow: 0 3px 0 #D68C94 !important; transform: translateY(2px); border: 2px solid white; }
        .key.pressed { transform: translateY(4px); box-shadow: 0 0 0 #ddd; }
        .key.error-flash { background-color: var(--key-error) !important; box-shadow: 0 0 10px var(--key-error); transform: scale(1.1); transition: all 0.1s; }
        .keyboard.fingers .key { border-bottom: 3px solid rgba(0,0,0,0.1); }
        .keyboard.fingers .f-pinky { background-color: #FFCDD2; } .keyboard.fingers .f-ring { background-color: #FFE0B2; } .keyboard.fingers .f-mid { background-color: #FFF9C4; } .keyboard.fingers .f-idx-l { background-color: #C8E6C9; } .keyboard.fingers .f-idx-r { background-color: #B3E5FC; } .keyboard.fingers .hand-split { border-right: 2px dashed #999; margin-right: 4px; }
        .overlay-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        #start-screen { background: transparent; } #level-screen { background: transparent; } #modal-screen { background: transparent !important; }
        .hidden { display: none !important; }
        h1 { font-size: 4rem; color: var(--primary); margin: 0; text-shadow: 2px 2px 0 #fff; }
        #start-screen h1, #level-screen h1, #modal-screen h1 { color: white; text-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #start-screen h2 { color: white; text-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn { background: var(--secondary); border: none; padding: 12px 30px; border-radius: 50px; font-size: 1.3rem; font-family: 'Fredoka', sans-serif; font-weight: bold; color: var(--dark); cursor: pointer; margin: 8px; box-shadow: 0 4px 0 #8AC6B3; transition: transform 0.1s; }
        .btn:hover { transform: scale(1.05); } .btn:active { transform: scale(0.95) translateY(4px); box-shadow: none; }
        .btn.small { padding: 8px 15px; font-size: 0.9rem; box-shadow: 0 2px 0 #8AC6B3; }
        .btn.toggle-on { background: var(--secondary); } .btn.toggle-off { background: var(--btn-inactive); color: #888; box-shadow: 0 2px 0 #ccc; }
        .user-switch { display: flex; gap: 10px; margin-bottom: 20px; background: rgba(255,255,255,0.5); padding: 5px; border-radius: 30px; backdrop-filter: blur(5px); }
        .user-btn { padding: 10px 30px; border-radius: 25px; border: none; cursor: pointer; font-weight: bold; font-size: 1.2rem; background: transparent; color: #fff; transition: all 0.2s; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .user-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-shadow: none; }
        .star-header { background: white; padding: 10px 25px; border-radius: 50px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 1.4rem; font-weight: bold; color: var(--dark); display: flex; align-items: center; gap: 15px; }
        .star-header span { display: flex; align-items: center; gap: 5px; }
        .star-header .gold { color: gold; text-shadow: 0 1px 1px rgba(0,0,0,0.2); }
        .level-grid { display: flex; flex-direction: column; gap: 20px; margin-top: 10px; max-height: 55vh; overflow-y: auto; padding: 15px; width: 85%; }
        .level-block { background: rgba(255,255,255,0.3); padding: 15px; border-radius: 20px; backdrop-filter: blur(5px); }
        .level-block-title { font-size: 1.5rem; color: white; margin-bottom: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.2); text-align: left; padding-left: 10px; display: flex; justify-content: space-between; align-items: center; }
        .level-block-content { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .level-btn { background: #fff; border: 3px solid rgba(0,0,0,0.05); padding: 10px; border-radius: 15px; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05); opacity: 0.9; position: relative; overflow: hidden; }
        .level-btn:hover { transform: scale(1.05); opacity: 1; z-index: 10; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .level-btn.active-level { border: 4px solid #fff; transform: scale(1.1); z-index: 2; box-shadow: 0 0 15px rgba(255,255,255,0.8); }
        .level-btn.locked { filter: grayscale(1); opacity: 0.6; cursor: not-allowed; pointer-events: none; }
        .level-btn.locked::after { content: "üîí"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; opacity: 0.5; }
        .level-stars { color: gold; font-size: 1rem; text-shadow: 0 1px 1px rgba(0,0,0,0.2); }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; background: white; padding: 30px; border-radius: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-height: 70vh; overflow-y: auto; width: 700px; }
        .setting-group label { font-weight: bold; color: var(--primary); }
        select { width: 100%; padding: 8px; border-radius: 8px; border: 2px solid var(--secondary); font-family: 'Fredoka', sans-serif; }
        .grid-full { grid-column: span 2; border-top: 1px solid #eee; padding-top: 10px; }
        #level-flash { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 6rem; color: var(--primary); font-weight: bold; opacity: 0; pointer-events: none; z-index: 200; text-shadow: 2px 2px 0 #fff, 0 0 20px rgba(255,255,255,0.8); text-align: center; width: 100%; transition: opacity 0.5s; display: flex; flex-direction: column; align-items: center;}
        #flash-countdown { font-size: 4rem; color: #4A404F; margin-top: 10px; }
        #minigame-ui { position: absolute; top: 20px; right: 20px; z-index: 60; }
        .result-stats { width: 500px; background: rgba(255,255,255,0.95); padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); backdrop-filter: blur(5px); }
        .bar-bg { width: 100%; height: 15px; background: #eee; border-radius: 10px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: width 1s ease-out; }
        .bar-fill.green { background-color: #4CAF50; } .bar-fill.blue { background-color: #42A5F5; }
        .result-text-box { width: 100%; height: 80px; overflow-y: auto; background: #f4f4f4; border-radius: 10px; padding: 10px; margin-top: 15px; text-align: left; font-family: monospace; font-size: 1.1rem; border: 2px solid #eee; white-space: pre-wrap; }
        .res-char.correct { color: #4CAF50; } .res-char.wrong { color: #FF5252; text-decoration: line-through; font-weight: bold; }
        .result-stars { font-size: 4rem; margin: 10px 0; display: inline-block; }
        .pop-stars { animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; text-shadow: 0 0 20px gold, 0 0 10px orange; }
        .five-stars { color: var(--gold); animation: pulseGold 1s infinite; text-shadow: 0 0 30px var(--gold); }
        @keyframes pulseGold { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 70% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .shake { animation: shake 0.3s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    <div id="global-bg"><canvas id="bg-canvas"></canvas></div>

    <div id="level-flash">
        <div id="flash-title">Level 1</div>
        <div id="flash-countdown"></div>
    </div>

    <div id="ui-layer" class="hidden">
        <header class="ui-element">
            <div class="header-left">
                <button class="btn small" id="btn-menu">üè† Level 1</button>
                <button class="btn small" id="btn-options">üîß Optionen</button>
            </div>
            <div class="header-right">
                <div class="vol-control"><span>üéµ Musik</span><input type="range" id="vol-music" min="0" max="100" value="80"></div>
                <div class="vol-control"><span>üîä Effekte</span><input type="range" id="vol-sfx" min="0" max="100" value="20"></div>
                <div class="score-box"><span>‚≠ê <span id="score-val">0</span></span><div class="progress-container"><div class="progress-bar" id="prog-bar"></div></div></div>
                <button class="btn small toggle-off" id="btn-loop">üîÅ Loop</button>
                <button class="btn small toggle-on" id="btn-bonus">üéÅ Bonus</button>
            </div>
        </header>
        <div id="target-display"><div id="current-char">Start!</div><div id="next-chars"></div></div>
        <div id="keyboard-wrapper" class="ui-element"><div class="keyboard" id="onscreen-keyboard"></div></div>
    </div>

    <div id="start-screen" class="overlay-screen">
        <h1>Hedy's TastenZauber</h1>
        <h2>Lerne Tippen mit dem magischen Fuchs!</h2>
        <button class="btn" id="btn-start-game">Los geht's! (Enter)</button>
    </div>

    <div id="level-screen" class="overlay-screen hidden">
        <h1>Level Auswahl</h1>
        <div class="user-switch"><button class="user-btn active" id="user-hedy">Hedy</button><button class="user-btn" id="user-keno">Keno</button></div>
        <div id="star-summary" class="star-header">
            <span>Gesamt: <span class="gold">‚≠ê</span> <span id="total-stars-val">0</span></span>
            <span style="font-size: 1rem; opacity: 0.8;">|</span>
            <span id="next-unlock-info">N√§chstes Ziel: 30 ‚≠ê</span>
        </div>
        <div class="level-grid" id="level-container"></div>
    </div>

    <div id="options-screen" class="overlay-screen hidden" style="background: rgba(255,255,255,0.95);">
        <h1>Optionen</h1>
        <div class="settings-grid">
            <div class="setting-group"><label>‚å®Ô∏è Layout</label><select id="sel-kb-layout"><option value="simple">Einfach</option><option value="macbook" selected>MacBook</option></select></div>
            <div class="setting-group"><label>üé® Farben</label><select id="sel-kb-color"><option value="standard">Wei√ü</option><option value="fingers" selected>Bunt</option></select></div>
            <div class="setting-group"><label>‚ö†Ô∏è Fehler</label><select id="sel-kb-error"><option value="subtle">Dezent</option><option value="flash" selected>Aufleuchten</option></select></div>
            <div class="setting-group"><label>üí• Effekt</label><select id="sel-expl"><option value="on">Standard</option><option value="ultra">ULTRA üî•</option><option value="grow" selected>Grow üå±</option><option value="off">Aus</option></select></div>
            <div class="setting-group"><label>ü§∏ Animation</label><select id="sel-anim"><option value="jump">Springen</option><option value="chase">Jagd</option><option value="spin">Drehen</option><option value="wink">Zwinkern</option><option value="mouth">Sprechen</option><option value="grow">Wachsen</option><option value="shrink">Schrumpfen</option><option value="random">Zufall</option></select></div>
            <div class="setting-group"><label>üîä Sound</label><select id="sel-sfx"><option value="click" selected>Klick</option><option value="piano">Piano</option><option value="8bit">8-Bit</option><option value="bubble">Blubber</option><option value="magic">Magie</option><option value="robot">Roboter</option><option value="off">Aus</option></select></div>
            <div class="setting-group"><label>üéµ Musik</label><select id="sel-bgm"><option value="keychill" selected>KeyChill (MP3)</option><option value="lullaby">Lullaby</option><option value="off">Aus</option></select></div>
            <div class="setting-group"><label>ü¶Ñ Tier</label><select id="sel-mascot"><option value="fox">Fuchs</option><option value="unicorn">Einhorn</option><option value="bear">B√§r</option><option value="bunny">Hase</option><option value="cat">Katze</option><option value="dog_billy">Billy</option><option value="robot">Roboter</option><option value="random">Zufall</option></select></div>
            <div class="setting-group"><label>üåç Welt</label><select id="sel-theme"><option value="forest">Wald</option><option value="candy">S√º√ü</option><option value="ice">Eis</option><option value="space">All</option><option value="underwater">Meer</option><option value="random">Zufall</option></select></div>
        </div>
        <button class="btn" id="btn-close-options">Zur√ºck</button>
    </div>

    <div id="pause-screen" class="overlay-screen hidden">
        <h1>Pause</h1>
        <button class="btn" id="btn-resume">Weiter (Esc)</button>
        <button class="btn small" id="btn-quit">Zum Men√º</button>
    </div>

    <div id="modal-screen" class="overlay-screen hidden">
        <h1 id="modal-title">Super!</h1>
        <div class="result-stars" id="result-stars"></div>
        <div class="result-stats">
            <div class="stat-row"><div class="stat-label"><span>Tempo</span> <span id="lbl-speed"></span></div><div class="bar-bg"><div class="bar-fill green" id="bar-speed"></div></div></div>
            <div class="stat-row"><div class="stat-label"><span>Genauigkeit</span> <span id="lbl-acc"></span></div><div class="bar-bg"><div class="bar-fill blue" id="bar-acc"></div></div></div>
            <div class="stat-row"><div class="stat-label"><span>Dein Text:</span></div><div class="result-text-box" id="result-text-display"></div></div>
        </div>
        <button class="btn" id="btn-modal-action">Weiter (Enter)</button>
        <button class="btn" id="btn-repeat-level" style="margin-left:5px;">Wiederholen</button>
        <button class="btn small" id="btn-direct-next" style="margin-top: 5px; background-color: rgba(255,255,255,0.8);">Zu Level X</button>
    </div>

    <script>
        const generateLevels = () => {
            const levels = [];
            const add = (id, name, keys, content) => levels.push({ id, name, keys, content });
            
            add(1, "Grundstellung: f j", "fj", "fff jjj fjfj jfjf fj jf ff jj fff jjj fjfj");
            add(2, "Grundstellung: d k", "fjdk", "ddd kkk dkdk kdkd dj fj dk kd fd jd kf jf");
            add(3, "Grundstellung: s l", "fjdksl", "sss lll slsl lsls ds ks fs js as la sl");
            add(4, "Grundstellung: a √∂", "fjdksla√∂", "aaa √∂√∂√∂ a√∂a√∂ √∂a√∂a sa la fa ja al √∂s l√∂");
            add(5, "Mitte: g h", "all", "ggg hhh ghgh hghg fg jh dg kh ag √∂h gl hl");
            add(6, "W√∂rter Grundreihe", "all", "hallo da als das glas ja saal fass hasse kahl");
            add(7, "S√§tze Grundreihe", "all", "Hallo Saskia. Das Glas ist da. Ja, das ist alles.");
            add(8, "Mix Grundreihe", "all", "asdf jkl√∂ ghjk aass ddff jjkk ll√∂√∂ fghj");
            add(9, "Speed Grundreihe", "all", "fad gas jagd hals kaff saal lass fall das");
            add(10, "Test Grundreihe", "all", "Saskia ass das Glas. Hallo Papa. Ja, das ist das Haus.");
            
            add(11, "Oberreihe: e i", "all ei", "eee iii ei ie see fee eil idee seele eil");
            add(12, "W√∂rter mit e i", "all ei", "die idee see eis teil lied hier diese");
            add(13, "Oberreihe: r t", "all eirt", "rrr ttt tr rt er te treter rat tat tier");
            add(14, "W√∂rter mit r t", "all eirt", "treten rate tasten rest dort tier drei");
            add(15, "Oberreihe: u", "all eirtu", "uuu tut rut urt hut hutte tau durst");
            add(16, "W√∂rter mit u", "all eirtu", "hut tutu tau rustet durst turm stunde");
            add(17, "Oberreihe: z w o", "all eirtuzwo", "zzz www ooo zu wo ort wort toll zwei");
            add(18, "W√∂rter mit z w o", "all eirtuzwo", "zwei wort wo ort zoo wert witz oz");
            add(19, "Oberreihe: q p √º", "all eirtuzwoqp√º", "qqq ppp √º√º√º quer post qual pott t√ºr");
            add(20, "W√∂rter mit q p √º", "all eirtuzwoqp√º", "quer pferd post √ºben t√ºr fr√ºh gr√ºn");
            add(21, "Mix Oberreihe", "all", "trete quip zeit wort t√ºr post quer");
            add(22, "Test Oberreihe", "all", "Die T√ºr ist zu. Zwei Pferde laufen quer √ºber die Stra√üe.");
            
            add(23, "Unterreihe: c v", "all", "ccc vvv cv vc victor cave viel vater");
            add(24, "W√∂rter mit c v", "all", "victor cave virus vor viel vater");
            add(25, "Unterreihe: b n", "all", "bbb nnn bn nb band nein bin nass");
            add(26, "W√∂rter mit b n", "all", "band nein bin nass name bank");
            add(27, "Unterreihe: m y", "all", "mmm yyy mutter yoga yacht typ");
            add(28, "W√∂rter mit m y", "all", "mutter mama mehr yoga typ yacht");
            add(29, "Unterreihe: x √ü", "all", "xxx √ü√ü√ü box taxi stra√üe gro√ü");
            add(30, "W√∂rter mit x √ü", "all", "box fax taxi mix stra√üe fu√ü gro√ü");
            add(31, "Mix Unterreihe", "all", "victor yoga stra√üe name box mutter");
            add(32, "Test Unterreihe", "all", "Victor besucht die Gro√ümutter in der Yachtstra√üe.");
            
            add(33, "Gro√üschreibung Intro", "all", "Hallo. Das Haus. Mama und Papa. Ja!");
            add(34, "Satzanf√§nge", "all", "Die Familie ist gl√ºcklich. Hedy lacht. Keno spielt.");
            add(35, "Frage und Ausrufe", "all", "Wer ist da? Super! Toll gemacht! Wie sch√∂n!");
            add(36, "Anf√ºhrungszeichen", "all", "Mama sagt: ‚ÄûKomm essen!‚Äú Papa ruft: ‚ÄûJa, lecker!‚Äú");
            add(37, "Gemischte S√§tze", "all", "Hedy fragt: ‚ÄûDarf ich?‚Äú Keno antwortet: ‚ÄûJa!‚Äú");
            add(38, "L√§ngere S√§tze", "all", "Die Familie geht spazieren. ‚ÄûWie sch√∂n!‚Äú, sagt Mama.");
            add(39, "Mix Gro√ü/Klein", "all", "Papa liest vor. ‚ÄûDas ist spannend‚Äú, fl√ºstert Hedy.");
            add(40, "Test Gro√üschreibung", "all", "‚ÄûHallo!‚Äú, ruft Keno. ‚ÄûKommt spielen!‚Äú, sagt Hedy fr√∂hlich.");
            
            add(41, "Zahlen 0-9", "all 0123456789", "111 222 333 444 555 666 777 888 999 000 123 456");
            add(42, "Einfache Rechnungen", "all", "1+1=2 3+4=7 5-2=3 10*2=20 15/3=5");
            add(43, "Telefonnummern", "all", "0176-1234567 030-888888 0151-23456789");
            add(44, "Zeichen: + - * / =", "all", "2+3=5 10-4=6 3*7=21 12/4=3");
            add(45, "Zeichen: ( )", "all", "(Hallo) (1+2)*3 (Hedy und Keno)");
            add(46, "Zeichen: @ ‚Ç¨", "all", "info@beispiel.de 9,99‚Ç¨ 100‚Ç¨ 0,50‚Ç¨");
            add(47, "Jahre und Daten", "all", "13.12.2025 01.01.2026 Hedy ist 8 Jahre alt.");
            add(48, "Gemischte Zahlen", "all", "Keno hat 12 Punkte. Hedy 15. Super!");
            add(49, "Mix Zahlen/Zeichen", "all", "(+49) 030/123456 info@familie.de");
            add(50, "Test Zahlen/Zeichen", "all", "Am 13.12.2025 kostet das Spiel 19,99‚Ç¨. Tel: 0176-12345678.");
            
            add(51, "Fr√ºhst√ºck", "all", "Mama macht Fr√ºhst√ºck. Papa trinkt Kaffee. Hedy isst Brot. Keno mag M√ºsli. Alle sind fr√∂hlich.");
            add(52, "Im Garten", "all", "Hedy und Keno spielen im Garten. Papa wirft den Ball. Mama lacht. Der Hund bellt mit.");
            add(53, "Am Meer", "all", "Die Familie f√§hrt ans Meer. Hedy baut eine Sandburg. Keno schwimmt. Papa und Mama sonnen sich.");
            add(54, "Abendessen", "all", "Mama kocht Pasta. Papa erz√§hlt einen Witz. Hedy und Keno lachen. Es schmeckt lecker.");
            add(55, "Helfen", "all", "Hedy deckt den Tisch. Keno hilft beim Kochen. Papa r√§umt auf. Sie sind ein super Team!");
            add(56, "Zoo-Besuch", "all", "Im Zoo sehen sie Elefanten und Affen. Keno lacht √ºber die Affen. Hedy f√ºttert Ziegen.");
            add(57, "Spiel gewonnen", "all", "Keno gewinnt beim Brettspiel. Er jubelt: ‚ÄûHurra!‚Äú Hedy klatscht. Papa sagt: ‚ÄûSuper!‚Äú");
            add(58, "Bild malen", "all", "Hedy malt ein Bild der Familie. Mama h√§ngt es auf. Papa sagt: ‚ÄûDas ist wundersch√∂n!‚Äú");
            add(59, "Abendgeschichte", "all", "Papa liest vor. Hedy und Keno kuscheln sich ein. Mama bringt Kakao. Es ist gem√ºtlich.");
            add(60, "Gute Nacht", "all", "Alle gehen ins Bett. ‚ÄûGute Nacht!‚Äú, sagt Mama. ‚ÄûSchlaft sch√∂n!‚Äú, sagt Papa.");
            
            add(61, "Waldabenteuer", "all", "Hedy und Keno erkunden den Wald. Sie finden einen kleinen Schatz. Mama und Papa sind stolz auf die mutigen Kinder.");
            add(62, "Rad fahren lernen", "all", "Keno lernt Rad fahren. Papa h√§lt hinten fest. Pl√∂tzlich f√§hrt er allein! Alle jubeln: ‚ÄûBravo, Keno!‚Äú");
            add(63, "Kuchen backen", "all", "Hedy backt mit Mama einen Kuchen. Er duftet wunderbar. Papa und Keno essen zwei St√ºcke. ‚ÄûLecker!‚Äú, sagen sie.");
            add(64, "Picknick", "all", "Im Park machen sie Picknick. Die Sonne scheint hell. Sie essen Sandwiches und spielen Frisbee.");
            add(65, "Lustiger Drache", "all", "Hedy und Keno tr√§umen von einem freundlichen Drachen. Er fliegt mit ihnen √ºber das Haus. Mama und Papa winken von unten.");
            add(66, "Zauberblumen", "all", "Im Garten wachsen pl√∂tzlich riesige Blumen. Keno gie√üt sie. Hedy pfl√ºckt eine f√ºr Mama. Papa staunt: ‚ÄûDas ist Magie!‚Äú");
            add(67, "Superhelden", "all", "Papa ist der starke Held. Mama kann zaubern. Hedy fliegt hoch. Keno ist superschnell. Zusammen retten sie den Tag!");
            add(68, "Bauernhof", "all", "Sie besuchen einen Bauernhof. Hedy melkt eine Kuh. Keno f√ºttert K√ºken. Mama streichelt Pferde. Papa hilft beim Heu.");
            add(69, "Rieseneis", "all", "Sie essen den gr√∂√üten Eisbecher der Welt. Mit Schoko, Vanille und Erdbeere. Alle schlecken gl√ºcklich.");
            add(70, "Weihnachten", "all", "Zu Weihnachten backen sie Pl√§tzchen. Hedy dekoriert. Keno isst Teig. Mama singt. Papa schm√ºckt den Baum.");
            
            add(71, "Sommergrillen", "all", "Im Sommer grillen sie im Garten. Papa macht W√ºrstchen. Mama Salat. Hedy und Keno spielen bis sp√§t Verstecken.");
            add(72, "Roboter bauen", "all", "Keno baut einen Roboter aus Karton. Er tanzt lustig. Hedy lacht. Mama und Papa klatschen: ‚ÄûGenial!‚Äú");
            add(73, "Familienreise", "all", "Die Familie packt den Koffer und f√§hrt ans Meer. Sie bauen Sandburgen, schwimmen und essen Eis. Es ist das beste Abenteuer!");
            add(74, "Zaubertag", "all", "Heute ist Zaubertag! Alles wird bunt. Hedy zaubert Blumen, Keno Eis, Mama Kuchen und Papa Spielzeug. Alle tanzen vor Freude.");
            add(75, "Schatzsuche", "all", "Mit einer Schatzkarte suchen sie im Wald. Am Ende finden sie Schokoladengold! ‚ÄûHurra!‚Äú, rufen Hedy und Keno.");
            add(76, "Gro√üe Party", "all", "Zur Geburtstagsfeier kommen alle Freunde. Es gibt Kuchen, Spiele, Musik und Luftballons. Papa tanzt lustig, Mama singt mit, Hedy und Keno sind die Stars des Abends.");
            add(77, "Traumwelt", "all", "In der Traumwelt fliegen sie auf Wolken, besuchen Sterne und essen Mondkuchen. Die Familie lacht den ganzen Tag und nachts. Es ist die sch√∂nste Welt ever!");
            add(78, "Detektive", "all", "Hedy und Keno spielen Detektive. Sie suchen den verlorenen Teddy. Mit Mama und Papa finden sie ihn im Garten. ‚ÄûFall gel√∂st!‚Äú, rufen sie stolz.");
            add(79, "Weltreise", "all", "Stellt euch vor, die Familie reist um die Welt: Paris, New York, Tokio! Sie sehen den Eiffelturm, essen Pizza in Italien und Sushi in Japan. Unvergesslich!");
            add(80, "Zirkus", "all", "Sie gehen in den Zirkus. Clowns machen Witze, L√∂wen springen durch Reifen, Akrobaten fliegen hoch. Keno lacht am lautesten, Hedy staunt mit offenem Mund.");
            
            add(81, "Erfindung", "all", "Keno erfindet eine Maschine, die Hausaufgaben macht. Hedy testet sie. Mama und Papa sind begeistert ‚Äì bis sie nur Witze schreibt! Alle lachen herzlich.");
            add(82, "Winterzauber", "all", "Im Winter bauen sie einen Schneemann. Sie rodeln den H√ºgel hinunter. Mama macht hei√üen Kakao. Abends sitzen alle am Kamin und erz√§hlen Geschichten.");
            add(83, "Unterwasserwelt", "all", "Im Traum tauchen sie ins Meer. Sie schwimmen mit Delfinen, sehen bunte Fische und eine Schatztruhe. Papa √∂ffnet sie ‚Äì voller Schokolade!");
            add(84, "Ritter und Prinzessin", "all", "Hedy ist die mutige Prinzessin, Keno der tapfere Ritter. Sie bek√§mpfen einen freundlichen Drachen, der nur Kuscheln will. Happy End!");
            add(85, "Raumfahrt", "all", "Die Familie baut eine Rakete und fliegt zum Mond. Sie springen in niedriger Schwerkraft, pflanzen eine Flagge und essen Mondk√§se. Wow!");
            add(86, "Magischer Wald", "all", "Im magischen Wald sprechen die Tiere. Ein Fuchs zeigt ihnen den Weg zu einer Lichtung mit tanzenden Feen. Mama tanzt mit, Papa filmt alles.");
            add(87, "Zeitreise", "all", "Mit einer Zeitmaschine reisen sie zu Dinosauriern. Sie sehen T-Rex und fliegen auf einem Pterodactyl. Zur√ºck in der Gegenwart erz√§hlen sie alles.");
            add(88, "Olympiade", "all", "Die Familie macht eine eigene Olympiade: Laufen, Springen, Ballwerfen. Jeder gewinnt eine Medaille. ‚ÄûWir sind alle Sieger!‚Äú, sagt Papa.");
            add(89, "Geheimversteck", "all", "Hedy und Keno bauen ein geheimes Baumhaus. Nur die Familie darf rein. Dort lesen sie Comics, essen Kekse und planen neue Abenteuer.");
            add(90, "Das gr√∂√üte Fest", "all", "Am Jahresende feiern sie das gr√∂√üte Fest. Mit Feuerwerk, Geschenken, Liedern und Umarmungen. Die beste Familie der Welt!");
            
            add(91, "Das gro√üe Abenteuerbuch", "all", "Es war einmal eine Familie: Mama, Papa, Hedy und Keno. Sie lebten in einem sch√∂nen Haus mit gro√üem Garten. Eines Tages fanden die Kinder eine alte Schatzkarte hinter dem Schrank. ‚ÄûLasst uns den Schatz suchen!‚Äú, rief Keno aufgeregt. Mama und Papa lachten: ‚ÄûNa klar, Abenteuerzeit!‚Äú Sie packten Rucks√§cke mit Proviant und machten sich auf den Weg in den nahegelegenen Wald.");
            add(92, "Fortsetzung Schatzsuche", "all", "Im Wald folgten sie der Karte. Zuerst kamen sie an einen Bach. ‚ÄûWir brauchen eine Br√ºcke!‚Äú, sagte Hedy clever. Keno fand √Ñste, und zusammen bauten sie eine. Papa half tragen, Mama motivierte alle. Pl√∂tzlich h√∂rten sie ein Rascheln ‚Äì ein kleiner Fuchs erschien und zeigte ihnen den Weg weiter.");
            add(93, "Der magische Baum", "all", "Am Ende der Karte stand ein riesiger alter Baum. Unter seinen Wurzeln glitzerte eine Truhe. Sie √∂ffneten sie vorsichtig ‚Äì voller Goldm√ºnzen aus Schokolade! ‚ÄûDer beste Schatz!‚Äú, jubelte Hedy. Sie setzten sich hin, a√üen Schokolade und erz√§hlten Geschichten bis die Sonne unterging.");
            add(94, "Heimkehr", "all", "Zu Hause angekommen, erz√§hlten sie den ganzen Tag von ihrem Abenteuer. Mama machte ein Foto von allen mit der Truhe. Papa sagte stolz: ‚ÄûIhr seid die mutigsten Entdecker!‚Äú Abends kuschelten sie zusammen und tr√§umten von neuen Abenteuern.");
            add(95, "Motivation", "all", "Du hast schon so weit geschafft! Alle Buchstaben, Zahlen und Zeichen sitzen perfekt. Deine Finger fliegen √ºber die Tastatur. Mama, Papa, Hedy und Keno klatschen Beifall f√ºr dich!");
            add(96, "Fast am Ziel", "all", "Nur noch ein paar Level. Du tippst jetzt blitzschnell und fehlerfrei. Das 10-Finger-System ist dein! Weiter so ‚Äì du bist ein echter Champion!");
            add(97, "Letzte gro√üe Geschichte 1", "all", "Stell dir vor, du bist mit Hedy und Keno unterwegs. Ihr baut das gr√∂√üte Baumhaus der Welt, fliegt mit selbstgebauten Fl√ºgeln und findet einen verborgenen Wasserfall mit Regenbogenfischen. Mama und Papa kommen nach und machen ein riesiges Picknick. Alle lachen, singen und tanzen bis Mitternacht.");
            add(98, "Letzte gro√üe Geschichte 2", "all", "Eines Tages √∂ffnet sich ein Portal im Garten. Die Familie tritt hindurch und landet in einer Welt aus S√º√üigkeiten. Schokoladenberge, Gummib√§rseen und Lakritzbr√ºcken! Sie erkunden alles, treffen freundliche Bonbon-Drachen und kehren mit vollen Taschen nach Hause zur√ºck. Das war das s√º√üeste Abenteuer ever!");
            add(99, "Vor dem Finale", "all", "Du bist bereit f√ºr das gro√üe Finale. Deine Geschwindigkeit ist top, deine Genauigkeit perfekt. Hedy sagt: ‚ÄûWow!‚Äú, Keno: ‚ÄûSuper!‚Äú, Mama und Papa: ‚ÄûWir sind so stolz auf dich!‚Äú");
            add(100, "Gl√ºckwunsch ‚Äì 10-Finger-Meister!", "all", "Herzlichen Gl√ºckwunsch! Du hast alle 100 Level gemeistert. Du beherrschst das 10-Finger-System jetzt perfekt ‚Äì schnell, sicher und ohne hinzuschauen. Hedy, Keno, Mama und Papa jubeln: ‚ÄûDu bist der allerbeste Tipp-Star der Welt!‚Äú Feiere deinen Erfolg ‚Äì du hast es verdient!");

            return levels;
        };
        const LEVELS = generateLevels();
        
        // Level Block Beschreibungen
        const LEVEL_BLOCKS = [
            { id: 0, title: "Die Grundreihe (Home Row)", desc: "Lerne die wichtigsten Tasten!" },
            { id: 1, title: "Die Oberreihe", desc: "Es geht nach oben!" },
            { id: 2, title: "Die Unterreihe", desc: "Jetzt nach unten greifen!" },
            { id: 3, title: "Gro√üschreibung & Satzzeichen", desc: "Shift-Taste und Punkte" },
            { id: 4, title: "Zahlen & Symbole", desc: "1, 2, 3 und Zauberzeichen" },
            { id: 5, title: "Kurze S√§tze", desc: "Jetzt schreiben wir richtig!" },
            { id: 6, title: "Kleine Geschichten", desc: "Es wird spannend..." },
            { id: 7, title: "Familien Abenteuer", desc: "Erlebe tolle Momente!" },
            { id: 8, title: "Phantasie Welten", desc: "Tr√§ume gro√ü!" },
            { id: 9, title: "Das gro√üe Finale", desc: "Werde zum Meister!" }
        ];

        class AudioManager {
            constructor() {
                this.ready = false; 
                this.sfxType = 'click'; 
                this.bgmType = 'keychill'; 
                this.musicVol = 0; this.sfxVol = 0; // dB
                
                this.reverb = new Tone.Reverb({ decay: 2, wet: 0.3 }).toDestination();
                this.bgmGain = new Tone.Volume(0).connect(this.reverb);
                this.sfxGain = new Tone.Volume(0).connect(this.reverb);

                this.poly = new Tone.PolySynth(Tone.Synth, { envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 1 } }).connect(this.sfxGain);
                this.metal = new Tone.MetalSynth({ harmonicity: 12, resonance: 800, modulationIndex: 20, envelope: { decay: 0.4, release: 0.2 }, volume: -10 }).connect(this.sfxGain);
                this.membrane = new Tone.MembraneSynth().connect(this.sfxGain);
                this.fm = new Tone.PolySynth(Tone.FMSynth, { modulationIndex: 10, envelope: { attack: 0.01, decay: 0.2 } }).connect(this.sfxGain);
                this.clickSynth = new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 2, envelope: { attack: 0.001, decay: 0.02, sustain: 0 }, volume: -5 }).connect(this.sfxGain);
                
                this.scale = ["C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5", "D5", "E5"];
                this.bgmSequence = null;
                this.bgmPlayer = null; 

                // Web Audio Custom
                this.waCtx = null;
                this.waMaster = null;
                this.waLoopId = null;
            }
            async init() { if (this.ready) return; await Tone.start(); this.ready = true; Tone.Transport.start(); this.updateBGM(); }
            
            initWebAudio() {
                if(this.waCtx) return;
                this.waCtx = new (window.AudioContext || window.webkitAudioContext)();
                this.waMaster = this.waCtx.createGain();
                this.waMaster.gain.value = 0.2; 
                this.waMaster.connect(this.waCtx.destination);
            }

            setVolume(type, val) {
                const db = val <= 0 ? -Infinity : Tone.gainToDb(val/100);
                if(type === 'music') {
                    this.bgmGain.volume.rampTo(db, 0.1);
                    if(this.waMaster) {
                        const linear = val <= 0 ? 0 : (val/100) * 0.5; 
                        this.waMaster.gain.setTargetAtTime(linear, this.waCtx.currentTime, 0.1);
                    }
                }
                if(type === 'sfx') this.sfxGain.volume.rampTo(db, 0.1);
            }

            setSettings(sfx, bgm) {
                this.sfxType = sfx;
                if(bgm === 'random') { const keys = Object.keys(this.bgmTracks); this.bgmType = keys[Math.floor(Math.random() * keys.length)]; } 
                else { this.bgmType = bgm; }
                this.updateBGM();
            }
            
            createPad(freq, start, duration) {
                if(!this.waCtx) return;
                const osc = this.waCtx.createOscillator();
                const gain = this.waCtx.createGain();
                const filter = this.waCtx.createBiquadFilter();
                osc.type = "sine"; osc.frequency.value = freq;
                filter.type = "lowpass"; filter.frequency.value = 800; 
                gain.gain.setValueAtTime(0, start);
                gain.gain.linearRampToValueAtTime(0.08, start + 2);
                gain.gain.linearRampToValueAtTime(0.05, start + duration - 2);
                gain.gain.linearRampToValueAtTime(0, start + duration);
                osc.connect(filter); filter.connect(gain); gain.connect(this.waMaster);
                osc.start(start); osc.stop(start + duration);
            }

            playWaChime() {
                if(!this.waCtx) return;
                const osc = this.waCtx.createOscillator(); const gain = this.waCtx.createGain();
                osc.type = 'sine'; osc.frequency.value = 880;
                gain.gain.setValueAtTime(0.1, this.waCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.waCtx.currentTime + 1.5);
                osc.connect(gain); gain.connect(this.waMaster);
                osc.start(); osc.stop(this.waCtx.currentTime + 1.5);
            }
            playWaPebbles() {
                if(!this.waCtx) return;
                const osc = this.waCtx.createOscillator(); const gain = this.waCtx.createGain();
                osc.type = 'triangle'; osc.frequency.value = 1200 + Math.random()*200;
                gain.gain.setValueAtTime(0.05, this.waCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.waCtx.currentTime + 0.1);
                osc.connect(gain); gain.connect(this.waMaster);
                osc.start(); osc.stop(this.waCtx.currentTime + 0.1);
            }
            playWaShimmer() {
                if(!this.waCtx) return;
                const now = this.waCtx.currentTime;
                [523.25, 659.25].forEach((f,i) => {
                    const osc = this.waCtx.createOscillator(); const gain = this.waCtx.createGain();
                    osc.type = 'sine'; osc.frequency.value = f;
                    gain.gain.setValueAtTime(0.03, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5 + i*0.1);
                    osc.connect(gain); gain.connect(this.waMaster);
                    osc.start(); osc.stop(now + 0.6);
                });
            }

            playWebAudioLoop() {
                if(!this.waCtx || !this.bgmType.startsWith('webaudio') && !this.bgmType.startsWith('wa_')) return;
                const now = this.waCtx.currentTime;
                let notes = [220, 247, 196, 174]; 
                if (this.bgmType === 'wa_dream') notes = [130.81, 164.81, 196.00, 246.94]; 
                else if (this.bgmType === 'wa_sky') notes = [329.63, 293.66, 349.23, 392.00]; 
                else if (this.bgmType === 'wa_float') notes = [174.61, 220.00, 146.83, 130.81]; 
                const noteDuration = 8;
                let t = now;
                for (let i = 0; i < notes.length; i++) { this.createPad(notes[i], t, noteDuration); t += noteDuration; }
                this.waLoopId = setTimeout(() => this.playWebAudioLoop(), notes.length * noteDuration * 1000);
            }

            playCorrect(index) {
                if (!this.ready || this.sfxType === 'off') return;
                let type = this.sfxType;
                if (type === 'random') { const types = ['piano', 'click', '8bit', 'bubble', 'magic', 'robot', 'wood', 'zap', 'wa_chime', 'wa_pebbles', 'wa_shimmer']; type = types[Math.floor(Math.random() * types.length)]; }
                if (type === 'wa_chime') { this.playWaChime(); return; }
                if (type === 'wa_pebbles') { this.playWaPebbles(); return; }
                if (type === 'wa_shimmer') { this.playWaShimmer(); return; }
                const note = this.scale[index % this.scale.length]; const now = Tone.now();
                switch (type) {
                    case 'piano': this.poly.set({ oscillator: { type: "triangle" } }); this.poly.triggerAttackRelease(note, "8n", now); break;
                    case 'click': this.clickSynth.triggerAttackRelease("C6", "32n", now); break;
                    case '8bit': this.poly.set({ oscillator: { type: "square" }, envelope: { release: 0.1 } }); this.poly.triggerAttackRelease(note, "16n", now); break;
                    case 'bubble': this.membrane.triggerAttackRelease(note, "8n", now); break;
                    case 'magic': this.poly.set({ oscillator: { type: "sine" } }); this.poly.triggerAttackRelease(Tone.Frequency(note).transpose(12), "8n", now); break;
                    case 'robot': this.metal.triggerAttackRelease("32n", now); break;
                    case 'wood': this.poly.set({ oscillator: { type: "sine" }, envelope: { decay: 0.05, sustain: 0 } }); this.poly.triggerAttackRelease(note, "16n", now); break;
                    case 'zap': this.fm.triggerAttackRelease(note, "32n", now); break;
                }
            }
            playWrong() { if (!this.ready || this.sfxType === 'off') return; this.membrane.triggerAttackRelease("G2", "16n"); }
            playWin() { if (!this.ready || this.sfxType === 'off') return; const now = Tone.now(); this.poly.set({ oscillator: { type: "triangle" } }); this.poly.triggerAttackRelease("C4", "16n", now); this.poly.triggerAttackRelease("E4", "16n", now + 0.1); this.poly.triggerAttackRelease("G4", "16n", now + 0.2); this.poly.triggerAttackRelease("C5", "4n", now + 0.3); }
            playSuperWin() { if (!this.ready || this.sfxType === 'off') return; const now = Tone.now(); this.poly.set({ oscillator: { type: "sawtooth" } }); ["C3","E3","G3","C4","E4","G4","C5"].forEach((n,i) => this.poly.triggerAttackRelease(n, "8n", now + i*0.1)); }
            
            updateBGM() {
                if (!this.ready) return; 
                
                // Reset old BGM
                if (this.bgmSequence) { this.bgmSequence.dispose(); this.bgmSequence = null; }
                if (this.waLoopId) clearTimeout(this.waLoopId);
                if (this.waCtx && this.waCtx.state === 'running') this.waCtx.suspend();
                if (this.bgmPlayer) { this.bgmPlayer.stop(); this.bgmPlayer.dispose(); this.bgmPlayer = null; }

                if (this.bgmType === 'off') { Tone.Transport.stop(); return; }

                // New MP3 Handling
                if (this.bgmType === 'keychill') {
                    Tone.Transport.stop();
                    // Tone.Player loads the file
                    this.bgmPlayer = new Tone.Player({
                        url: "keychill.mp3",
                        loop: true,
                        autostart: true,
                        volume: -10
                    }).connect(this.bgmGain);
                    return;
                }

                if (this.bgmType === 'webaudio' || this.bgmType.startsWith('wa_')) {
                    Tone.Transport.stop();
                    this.initWebAudio();
                    this.waCtx.resume().then(() => { this.playWebAudioLoop(); });
                    return;
                }
                
                if(Tone.Transport.state !== 'started') Tone.Transport.start();
                this.bgmTracks = {
                    lullaby: { bpm: 60, notes: ["C4", null, "E4", null, "G4", null, "C3", null], synth: "triangle" },
                    tetris: { bpm: 140, notes: ["E4", "B3", "C4", "D4", "C4", "B3", "A3", "A3", "C4", "E4", "D4", "C4", "B3", null, "C4", "D4", "E4", "C4", "A3", "A3"], synth: "square" }, 
                    golden: { bpm: 100, notes: ["G4", "F#4", "E4", "D4", "G4", "F#4", "E4", "D4", "B3", "B3", "A3", "G3"], synth: "sine" }, 
                    takedown: { bpm: 130, notes: ["E3", "E3", "G3", "E3", "A3", "E3", "B3", "A3", "G3", "E3", "D3", "E3"], synth: "sawtooth" }, 
                    adventure: { bpm: 110, notes: ["C3", "G3", "C4", "E4", "F4", "E4", "D4", "B3"], synth: "square" },
                    space: { bpm: 50, notes: ["A2", null, "E3", "A3", null, "C4", null, "E4"], synth: "sine" },
                    funky: { bpm: 100, notes: ["C2", "C2", null, "Eb2", "F2", null, "G2", "Bb2"], synth: "sawtooth" },
                    zen: { bpm: 40, notes: ["E4", null, null, "A4", null, null, "B4", null], synth: "sine" },
                    arcade: { bpm: 140, notes: ["C4", "G3", "E3", "C3", "G3", "C4", "E4", "G4"], synth: "square" },
                    racer: { bpm: 130, notes: ["C2", "C2", "C2", "C2", "F2", "F2", "G2", "G2"], synth: "sawtooth" }
                };
                const track = this.bgmTracks[this.bgmType]; if (!track) return;
                Tone.Transport.bpm.value = track.bpm;
                const bgmSynth = new Tone.Synth({ oscillator: { type: track.synth }, envelope: { attack: 0.05, decay: 0.2, sustain: 0.2, release: 1 }, volume: -20 }).connect(this.bgmGain);
                this.bgmSequence = new Tone.Sequence((time, note) => { if (note) bgmSynth.triggerAttackRelease(note, "8n", time); }, track.notes, "8n").start(0);
            }
        }

        class World3D {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.scene = new THREE.Scene(); this.scene.fog = new THREE.FogExp2(0xE2F0CB, 0.02);
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.set(0, 2, 8); this.camera.lookAt(0, 1, 0);
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight); this.renderer.setPixelRatio(window.devicePixelRatio);
                this.container.appendChild(this.renderer.domElement);
                const hemiLight = new THREE.HemisphereLight(0xffffff, 0xffffff, 0.6); this.scene.add(hemiLight);
                this.dirLight = new THREE.DirectionalLight(0xffffff, 0.8); this.dirLight.position.set(5, 10, 7); this.scene.add(this.dirLight);
                
                this.mascot = new THREE.Group(); this.scene.add(this.mascot); 
                this.npc = new THREE.Group(); this.scene.add(this.npc); 
                
                this.animMode = 'jump'; this.setMascot("fox"); this.setTheme("forest");
                this.createEnvironment(); this.createParticles();
                
                // Chase state: player runs left to right, then appears right running left
                this.chaseState = { playerX: -8, npcX: -10, dir: 1 };

                window.addEventListener('resize', () => this.onResize());
                this.clock = new THREE.Clock(); this.animate();
            }
            setTheme(type) {
                if (type === 'random') { const types = ['forest', 'candy', 'ice', 'space', 'sunset', 'underwater', 'midnight']; type = types[Math.floor(Math.random() * types.length)]; }
                const themes = {
                    forest: { bg: 0xE2F0CB, fog: 0xE2F0CB, floor: 0xB5EAD7 }, candy: { bg: 0xFFE1E6, fog: 0xFFE1E6, floor: 0xFFB7B2 },
                    ice: { bg: 0xE0F7FA, fog: 0xE0F7FA, floor: 0xB2EBF2 }, space: { bg: 0x1A1A2E, fog: 0x1A1A2E, floor: 0x16213E },
                    sunset: { bg: 0xFFD3B6, fog: 0xFFD3B6, floor: 0xFFAAA5 }, underwater: { bg: 0x22A6B3, fog: 0x22A6B3, floor: 0x7ED6DF },
                    midnight: { bg: 0x2C003E, fog: 0x2C003E, floor: 0x512B58 }
                };
                const t = themes[type]; document.body.style.backgroundColor = '#' + t.bg.toString(16); this.scene.fog.color.setHex(t.fog);
                if(this.islands) { this.islands.forEach(mesh => mesh.material.color.setHex(t.floor)); }
                if (type === 'space' || type === 'midnight') { this.dirLight.intensity = 0.5; } else { this.dirLight.intensity = 0.8; }
            }
            createCharacter(type, group) {
                while(group.children.length > 0){ group.remove(group.children[0]); }
                const colors = { 
                    fox: 0xFF9AA2, unicorn: 0xFFFFFF, bear: 0x8D6E63, bunny: 0xF0F4C3, 
                    cat: 0xB0BEC5, pig: 0xF48FB1, robot: 0x78909C, npc: 0x555555,
                    dog_billy: 0x8D6E63, dog_luni: 0xFFE082, dog_charlie: 0x3E2723 
                };
                const col = colors[type] || 0xFF9AA2;
                const matBody = new THREE.MeshStandardMaterial({ color: col });
                const body = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 1.2), matBody); body.position.y = 0.6; group.add(body);
                const head = new THREE.Mesh(new THREE.BoxGeometry(1.4, 1.4, 1.4), matBody); head.position.y = 2.0; group.add(head);
                const earGeo = new THREE.ConeGeometry(0.3, 0.6, 4);
                const earL = new THREE.Mesh(earGeo, matBody); earL.position.set(-0.4, 2.8, 0); earL.rotation.z = 0.2; group.add(earL);
                const earR = new THREE.Mesh(earGeo, matBody); earR.position.set(0.4, 2.8, 0); earR.rotation.z = -0.2; group.add(earR);
                const tail = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), matBody); tail.position.set(0, 0.6, -0.8); group.add(tail);
                const matDark = new THREE.MeshStandardMaterial({ color: 0x333333 });
                const eyeL = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.25, 0.1), matDark); eyeL.position.set(-0.35, 2.1, 0.7); group.add(eyeL);
                const eyeR = eyeL.clone(); eyeR.position.set(0.35, 2.1, 0.7); group.add(eyeR);
                if(group === this.mascot) { this.eyeL = eyeL; this.eyeR = eyeR; this.snout = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.3, 0.2), new THREE.MeshStandardMaterial({ color:0xffffff })); this.snout.position.set(0, 1.8, 0.75); group.add(this.snout); }
            }
            setMascot(type) {
                if (type === 'random') { const types = ['fox', 'unicorn', 'bear', 'bunny', 'cat', 'pig', 'robot']; type = types[Math.floor(Math.random() * types.length)]; }
                this.createCharacter(type, this.mascot);
                this.createCharacter('robot', this.npc);
                this.npc.visible = false;
            }
            createEnvironment() {
                while(this.scene.getObjectByName("env_island")) { this.scene.remove(this.scene.getObjectByName("env_island")); }
                this.islands = []; 
                const material = new THREE.MeshStandardMaterial({ color: 0xB5EAD7, flatShading: true });
                const mainIsland = new THREE.Mesh(new THREE.CylinderGeometry(6, 6, 2, 8), material); 
                mainIsland.position.y = -2; mainIsland.name = "env_island";
                this.scene.add(mainIsland); this.islands.push(mainIsland);
                for(let i=0; i<8; i++) {
                    const size = 1 + Math.random() * 2;
                    const dist = 8 + Math.random() * 6;
                    const angle = (i / 8) * Math.PI * 2;
                    const smallIsland = new THREE.Mesh(new THREE.CylinderGeometry(size, size/1.5, 1 + Math.random(), 6), material);
                    smallIsland.position.set(Math.cos(angle)*dist, -2 + Math.random(), Math.sin(angle)*dist);
                    smallIsland.name = "env_island";
                    this.scene.add(smallIsland); this.islands.push(smallIsland);
                }
            }
            createParticles() {
                const geometry = new THREE.BufferGeometry(); const vertices = [];
                for ( let i = 0; i < 200; i ++ ) { vertices.push(THREE.MathUtils.randFloatSpread( 20 ), THREE.MathUtils.randFloatSpread( 20 ), THREE.MathUtils.randFloatSpread( 20 )); }
                geometry.setAttribute( 'position', new THREE.Float32BufferAttribute( vertices, 3 ) ); this.particles = new THREE.Points( geometry, new THREE.PointsMaterial( { color: 0xFFFFFF, size: 0.1 } ) ); this.scene.add( this.particles );
            }
            triggerReaction() {
                if(this.animMode === 'chase') {
                     // Speed up slightly or jump
                     this.mascot.position.y = 1;
                     setTimeout(() => this.mascot.position.y = 0, 200);
                     return;
                }
                let mode = this.animMode;
                if(mode === 'random') { const modes = ['jump', 'wink', 'spin', 'mouth', 'grow', 'shrink']; mode = modes[Math.floor(Math.random() * modes.length)]; }
                
                if(mode === 'spin') { 
                    if (!this.isSpinning) { this.isSpinning = true; this.mascot.rotation.y = 0; }
                }
                else if(mode === 'jump') { this.jumpTime = 0; this.isJumping = true; }
                else if(mode === 'wink') { this.winkTime = 0; this.isWinking = true; }
                else if(mode === 'mouth') { this.mouthTime = 0; this.isMouthing = true; }
                else if(mode === 'grow') { this.scaleTime = 0; this.isGrowing = true; }
                else if(mode === 'shrink') { this.scaleTime = 0; this.isShrinking = true; }
            }
            resetChase() {
                this.chaseState = { playerX: -8, npcX: -10, dir: 1 };
                this.mascot.rotation.y = Math.PI / 2;
                this.npc.rotation.y = Math.PI / 2;
            }
            animate() {
                requestAnimationFrame(() => this.animate()); const delta = this.clock.getDelta(); const time = this.clock.getElapsedTime();
                
                if(this.animMode === 'chase') {
                    this.npc.visible = true;
                    // Move
                    const speed = 4 * delta;
                    this.chaseState.playerX += speed * this.chaseState.dir;
                    this.chaseState.npcX += speed * this.chaseState.dir;
                    
                    // Boundary check and Ping-Pong
                    if (Math.abs(this.chaseState.playerX) > 12) {
                        this.chaseState.dir *= -1;
                        this.mascot.rotation.y = this.chaseState.dir > 0 ? Math.PI / 2 : -Math.PI / 2;
                        this.npc.rotation.y = this.chaseState.dir > 0 ? Math.PI / 2 : -Math.PI / 2;
                        // Swap positions to start from the other side essentially
                        // but actually we just flip direction and they come back in
                    }
                    
                    this.mascot.position.x = this.chaseState.playerX;
                    this.npc.position.x = this.chaseState.npcX;
                    
                    if (!this.isJumping) this.mascot.position.y = Math.abs(Math.sin(time * 10)) * 0.5;
                    else this.mascot.position.y = 1 + Math.abs(Math.sin(time * 10)) * 0.5; // Jump higher if triggered

                    this.npc.position.y = Math.abs(Math.sin(time * 8)) * 0.5;
                    this.mascot.position.z = 1; this.npc.position.z = 1;

                } else {
                    this.npc.visible = false;
                    this.mascot.position.x = 0; this.mascot.position.z = 0;
                    if (this.isJumping) { this.jumpTime += delta * 5; this.mascot.position.y = Math.sin(this.jumpTime) * 1.5; if(this.jumpTime > Math.PI) { this.isJumping = false; this.mascot.position.y = 0; } } 
                    else if (this.isWinking) { this.winkTime += delta * 10; const s = Math.max(0.1, Math.cos(this.winkTime)); this.eyeL.scale.y = s; this.eyeR.scale.y = s; if(this.winkTime > Math.PI * 2) { this.isWinking = false; this.eyeL.scale.y = 1; this.eyeR.scale.y = 1; } }
                    else if(this.isSpinning) { 
                        this.mascot.rotation.y += delta * 12; 
                        if(this.mascot.rotation.y >= Math.PI * 2) { this.isSpinning = false; this.mascot.rotation.y = 0; } 
                    }
                    else if(this.isMouthing) { this.mouthTime += delta * 15; this.snout.position.z = 0.75 + Math.sin(this.mouthTime) * 0.1; if(this.mouthTime > Math.PI * 2) { this.isMouthing = false; this.snout.position.z = 0.75; } }
                    else if(this.isGrowing) { this.scaleTime += delta * 5; const s = 1 + Math.sin(this.scaleTime) * 0.3; this.mascot.scale.set(s,s,s); if(this.scaleTime > Math.PI) { this.isGrowing = false; this.mascot.scale.set(1,1,1); } }
                    else if(this.isShrinking) { this.scaleTime += delta * 5; const s = 1 - Math.sin(this.scaleTime) * 0.3; this.mascot.scale.set(s,s,s); if(this.scaleTime > Math.PI) { this.isShrinking = false; this.mascot.scale.set(1,1,1); } }
                    else { 
                        this.mascot.position.y = Math.sin(time * 1.5) * 0.2; 
                        this.mascot.rotation.y = 0;
                    }
                }
                if(this.particles) this.particles.rotation.y += 0.001; this.renderer.render(this.scene, this.camera);
            }
            onResize() { this.camera.aspect = window.innerWidth / window.innerHeight; this.camera.updateProjectionMatrix(); this.renderer.setSize(window.innerWidth, window.innerHeight); }
        }

        class Game {
            constructor() {
                this.currentUser = localStorage.getItem('tastenZauberUser') || 'Hedy';
                this.audio = new AudioManager();
                this.world = new World3D('canvas-container');
                this.currentLevelIdx = 0;
                this.targetString = "";
                this.currentIndex = 0;
                this.score = 0;
                this.errors = 0;
                this.startTime = 0;
                this.isGameActive = false;
                this.isPaused = false;
                this.typedHistory = [];
                this.isLooping = false;
                this.noBonus = false;
                this.kbLayout = 'macbook';
                this.kbColor = 'fingers';
                this.kbError = 'flash';
                this.explEnabled = 'on';

                this.shiftMap = {
                    "^": "¬∞", "1": "!", "2": "\"", "3": "¬ß", "4": "$", "5": "%",
                    "6": "&", "7": "/", "8": "(", "9": ")", "0": "=", "√ü": "?",
                    "<": ">", ",": ";", ".": ":", "-": "_", "#": "'", "+": "*",
                    "¬¥": "`"
                };

                this.ui = {
                    screens: {
                        start: document.getElementById('start-screen'),
                        game: document.getElementById('ui-layer'),
                        level: document.getElementById('level-screen'),
                        modal: document.getElementById('modal-screen'),
                        pause: document.getElementById('pause-screen'),
                        options: document.getElementById('options-screen')
                    },
                    display: {
                        current: document.getElementById('current-char'),
                        next: document.getElementById('next-chars'),
                        score: document.getElementById('score-val'),
                        bar: document.getElementById('prog-bar')
                    },
                    keyboard: document.getElementById('onscreen-keyboard'),
                    buttons: { loop: document.getElementById('btn-loop'), bonus: document.getElementById('btn-bonus'), menu: document.getElementById('btn-menu'), skip: document.getElementById('btn-skip-bonus'), directNext: document.getElementById('btn-direct-next'), repeat: document.getElementById('btn-repeat-level') },
                    inputs: { 
                        sfx: document.getElementById('sel-sfx'), bgm: document.getElementById('sel-bgm'), 
                        mascot: document.getElementById('sel-mascot'), theme: document.getElementById('sel-theme'),
                        anim: document.getElementById('sel-anim'),
                        kbLayout: document.getElementById('sel-kb-layout'),
                        kbColor: document.getElementById('sel-kb-color'),
                        kbError: document.getElementById('sel-kb-error'),
                        expl: document.getElementById('sel-expl'),
                        volMusic: document.getElementById('vol-music'),
                        volSfx: document.getElementById('vol-sfx')
                    },
                    flash: document.getElementById('level-flash'),
                    flashTitle: document.getElementById('flash-title'),
                    flashCount: document.getElementById('flash-countdown'),
                    miniUi: document.getElementById('minigame-ui'),
                    users: { hedy: document.getElementById('user-hedy'), keno: document.getElementById('user-keno') },
                    bgCanvas: document.getElementById('bg-canvas'),
                    bgContainer: document.getElementById('global-bg')
                };
                
                this.audio.setVolume('music', 80);
                this.audio.setVolume('sfx', 20);

                // --- RETURN FROM BONUS CHECK ---
                if (localStorage.getItem('tastenZauber_returning') === 'true') {
                    localStorage.removeItem('tastenZauber_returning');
                    // Skip start screen, go to levels
                    this.ui.screens.start.classList.add('hidden');
                    this.loadUserScores();
                    this.initKeyboardUI(); 
                    this.setupListeners(); 
                    this.initBackgroundEffect('rain'); 
                    this.renderLevelSelect();
                    this.showScreen('level'); // Show Level screen immediately
                } else {
                    this.loadUserScores();
                    this.initKeyboardUI(); 
                    this.setupListeners(); 
                    this.initBackgroundEffect('rain'); 
                    this.renderLevelSelect();
                }
            }

            initBackgroundEffect(mode, param) {
                if(this.bgInterval) clearInterval(this.bgInterval);
                const canvas = this.ui.bgCanvas;
                if(!canvas) return;
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                if (mode === 'rain') {
                    const fontSize = 60; 
                    const columns = canvas.width / fontSize;
                    const drops = [];
                    for(let i=0; i<columns; i++) drops[i] = Math.random() * -10;

                    this.bgInterval = setInterval(() => {
                        ctx.fillStyle = "rgba(0, 0, 0, 0.15)"; 
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
                        ctx.font = fontSize + "px Fredoka";
                        for(let i=0; i<drops.length; i++) {
                            const text = String.fromCharCode(48 + Math.floor(Math.random()*10)); 
                            ctx.fillText(text, i*fontSize, drops[i]*fontSize);
                            if(drops[i]*fontSize > canvas.height && Math.random() > 0.98) drops[i] = 0;
                            drops[i] += 0.25; 
                        }
                    }, 70);
                } else if (mode === 'animals') {
                    const animalCount = param || 1;
                    const emojis = ['ü¶ä', 'ü¶Ñ', 'üêª', 'üê∞', 'üê±', 'üê∑', 'ü§ñ', 'üê∂', 'üêï', 'üê©']; 
                    const walkers = [];
                    for(let i=0; i<animalCount; i++) {
                        walkers.push({
                            x: Math.random() * canvas.width,
                            y: Math.random() * canvas.height,
                            speed: 1 + Math.random() * 2,
                            icon: emojis[Math.floor(Math.random() * emojis.length)],
                            size: 20 + Math.random() * 30
                        });
                    }
                    this.bgInterval = setInterval(() => {
                        ctx.clearRect(0,0, canvas.width, canvas.height); 
                        for(let w of walkers) {
                            ctx.font = w.size + "px serif";
                            ctx.fillText(w.icon, w.x, w.y);
                            w.x += w.speed;
                            if(w.x > canvas.width) w.x = -50;
                        }
                    }, 30);
                } else {
                    ctx.clearRect(0,0, canvas.width, canvas.height);
                }
            }

            loadUserScores() {
                this.scores = JSON.parse(localStorage.getItem(`tastenZauberScores_${this.currentUser}`)) || {};
                this.ui.users.hedy.classList.toggle('active', this.currentUser === 'Hedy');
                this.ui.users.keno.classList.toggle('active', this.currentUser === 'Keno');
                this.maxUnlockedBlock = parseInt(localStorage.getItem(`tastenZauberMaxBlock_${this.currentUser}`)) || 0;
            }

            switchUser(name) {
                this.currentUser = name;
                localStorage.setItem('tastenZauberUser', name);
                this.loadUserScores();
                this.renderLevelSelect();
            }

            checkBlockUnlock() {
                const totalStars = Object.values(this.scores).reduce((a, b) => a + b, 0);
                let unlocked = 0;
                for(let b=1; b < LEVEL_BLOCKS.length; b++) {
                    if(totalStars >= b * 30) unlocked = b;
                    else break;
                }

                if (unlocked > this.maxUnlockedBlock) {
                    this.maxUnlockedBlock = unlocked;
                    localStorage.setItem(`tastenZauberMaxBlock_${this.currentUser}`, this.maxUnlockedBlock);
                    this.triggerUnlockEffect();
                }
                
                document.getElementById('total-stars-val').textContent = totalStars;
                const infoEl = document.getElementById('next-unlock-info');
                
                // --- SHOW BONUS HIGH SCORE HERE ---
                const bonusHigh = localStorage.getItem('tastenZauber_bonusHighScore') || 0;
                
                if (unlocked < LEVEL_BLOCKS.length - 1) {
                    const nextGoal = (unlocked + 1) * 30;
                    const diff = nextGoal - totalStars;
                    infoEl.innerHTML = `N√§chstes Ziel: ${diff} ‚≠ê (bei ${nextGoal}) <span style="margin-left:15px; color:#00f3ff;">üöÄ Bonus-Highscore: ${bonusHigh}</span>`;
                } else {
                    infoEl.innerHTML = `Alle Level offen! Super! <span style="margin-left:15px; color:#00f3ff;">üöÄ Bonus-Highscore: ${bonusHigh}</span>`;
                }

                return this.maxUnlockedBlock;
            }

            triggerUnlockEffect() {
                const bg = this.ui.bgContainer;
                bg.classList.add('rainbow-spin');
                this.audio.playSuperWin();
                
                const colors = ['#FFD700', '#FF69B4', '#00BFFF', '#7CFC00'];
                for(let i=0; i<50; i++) {
                    const p = document.createElement('div');
                    p.classList.add('particle', 'star');
                    p.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
                    document.body.appendChild(p);
                    const angle = Math.random() * Math.PI * 2;
                    const vel = 100 + Math.random() * 200;
                    p.style.left = '50%'; p.style.top = '50%';
                    
                    p.animate([
                        { transform: 'translate(-50%, -50%) scale(0)', opacity: 1 },
                        { transform: `translate(calc(-50% + ${Math.cos(angle)*vel}px), calc(-50% + ${Math.sin(angle)*vel}px)) scale(1.5)`, opacity: 0 }
                    ], { duration: 1500, easing: 'cubic-bezier(0,0,0,1)' }).onfinish = () => p.remove();
                }
                
                setTimeout(() => bg.classList.remove('rainbow-spin'), 3000);
            }

            renderLevelSelect() {
                const maxUnlocked = this.checkBlockUnlock(); 
                const container = document.getElementById('level-container'); container.innerHTML = "";
                const colors = ['#FF9AA2', '#FFB7B2', '#FFDAC1', '#E2F0CB', '#B5EAD7', '#C7CEEA', '#90CAF9', '#CE93D8', '#F48FB1', '#80CBC4'];
                
                LEVEL_BLOCKS.forEach((block, bIdx) => {
                    const blockDiv = document.createElement('div');
                    blockDiv.className = 'level-block';
                    
                    const isLocked = bIdx > maxUnlocked;
                    const title = document.createElement('div');
                    title.className = 'level-block-title';
                    const required = bIdx * 30;
                    const lockText = isLocked ? `<small style="font-size:0.9rem;">(Braucht ${required} ‚≠ê)</small> üîí` : 'üîì';
                    title.innerHTML = `<span>${block.title} <small style="font-size:0.8rem; font-weight:normal;">(${block.desc})</small></span> <span>${lockText}</span>`;
                    blockDiv.appendChild(title);

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'level-block-content';

                    for(let i=0; i<10; i++) {
                        const lvlIdx = bIdx * 10 + i;
                        if(lvlIdx >= LEVELS.length) break;
                        const lvl = LEVELS[lvlIdx];

                        const btn = document.createElement('div'); 
                        btn.className = 'level-btn';
                        
                        if(isLocked) btn.classList.add('locked');
                        
                        const colorIdx = bIdx % colors.length;
                        btn.style.backgroundColor = colors[colorIdx];

                        if (lvlIdx === this.currentLevelIdx) btn.classList.add('active-level');
                        const score = this.scores[lvl.id] || 0;
                        let stars = "";
                        if(score >= 1) stars += "‚≠ê"; if(score >= 2) stars += "‚≠ê"; if(score >= 3) stars += "‚≠ê"; if(score >= 4) stars += "‚≠ê"; if(score >= 5) stars += "üåü"; if(stars === "") stars = "‚ö™"; 
                        btn.innerHTML = `<h3>${lvl.id}</h3><p>${lvl.name}</p><div class="level-stars">${stars}</div>`;
                        if(!isLocked) btn.onclick = () => this.startLevel(lvlIdx);
                        contentDiv.appendChild(btn);
                    }
                    blockDiv.appendChild(contentDiv);
                    container.appendChild(blockDiv);
                });
            }

            initKeyboardUI() {
                const container = this.ui.keyboard; container.innerHTML = "";
                container.className = `keyboard ${this.kbLayout} ${this.kbColor}`;

                let rows = [];
                if(this.kbLayout === 'simple') {
                    rows = [ ["^", "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "√ü"], ["q", "w", "e", "r", "t", "z", "u", "i", "o", "p", "√º", "+"], ["a", "s", "d", "f", "g", "h", "j", "k", "l", "√∂", "√§", "#"], ["<", "y", "x", "c", "v", "b", "n", "m", ",", ".", "-", "SHIFT"] ];
                } else {
                    rows = [ ["Esc", "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "√ü", "Del"], ["Tab", "q", "w", "e", "r", "t", "z", "u", "i", "o", "p", "√º", "+", "Enter"], ["Caps", "a", "s", "d", "f", "g", "h", "j", "k", "l", "√∂", "√§", "#"], ["Shift", "<", "y", "x", "c", "v", "b", "n", "m", ",", ".", "-", "Shift"] ];
                }
                const fingers = {
                    '1': 'f-pinky', 'q': 'f-pinky', 'a': 'f-pinky', 'y': 'f-pinky', '<': 'f-pinky', 'shift': 'f-pinky',
                    '2': 'f-ring', 'w': 'f-ring', 's': 'f-ring', 'x': 'f-ring',
                    '3': 'f-mid', 'e': 'f-mid', 'd': 'f-mid', 'c': 'f-mid',
                    '4': 'f-idx-l', '5': 'f-idx-l', 'r': 'f-idx-l', 't': 'f-idx-l', 'f': 'f-idx-l', 'g': 'f-idx-l', 'v': 'f-idx-l', 'b': 'f-idx-l',
                    '6': 'f-idx-r', '7': 'f-idx-r', 'z': 'f-idx-r', 'u': 'f-idx-r', 'h': 'f-idx-r', 'j': 'f-idx-r', 'n': 'f-idx-r', 'm': 'f-idx-r',
                    '8': 'f-mid', 'i': 'f-mid', 'k': 'f-mid', ',': 'f-mid',
                    '9': 'f-ring', 'o': 'f-ring', 'l': 'f-ring', '.': 'f-ring',
                    '0': 'f-pinky', 'p': 'f-pinky', '√∂': 'f-pinky', '-': 'f-pinky', '√ü': 'f-pinky', '√º': 'f-pinky', '√§': 'f-pinky', '+': 'f-pinky', '#': 'f-pinky'
                };
                rows.forEach(rowKeys => {
                    const rowDiv = document.createElement('div'); rowDiv.className = 'row';
                    rowKeys.forEach(char => {
                        const keyDiv = document.createElement('div'); keyDiv.className = 'key';
                        keyDiv.textContent = char.length > 2 ? char : char.toUpperCase();
                        const dataChar = char.toLowerCase();
                        keyDiv.dataset.char = dataChar; 
                        keyDiv.dataset.normal = char; 
                        let shifted = char.toUpperCase();
                        if (this.shiftMap[char]) shifted = this.shiftMap[char];
                        keyDiv.dataset.shifted = shifted;
                        if(char.length > 1) keyDiv.classList.add(char === ' ' ? 'space' : 'wide');
                        if(char === 'Enter' || char === 'Shift' || char === 'Del' || char === 'Tab' || char === 'Caps') keyDiv.classList.add('cmd');
                        if(this.kbColor === 'fingers') {
                            const fClass = fingers[dataChar];
                            if(fClass) keyDiv.classList.add(fClass);
                            if (['5','t','g','b'].includes(dataChar)) keyDiv.classList.add('hand-split');
                        }
                        rowDiv.appendChild(keyDiv);
                    });
                    container.appendChild(rowDiv);
                });
                const spaceRow = document.createElement('div'); spaceRow.className = 'row'; const spaceKey = document.createElement('div'); spaceKey.className = 'key space'; spaceKey.dataset.char = " "; spaceKey.textContent = "LEERTASTE"; spaceRow.appendChild(spaceKey); container.appendChild(spaceRow);
            }

            toggleKeyboardShift(active) {
                document.querySelectorAll('.key').forEach(k => {
                    if (k.dataset.shifted) {
                        const newChar = active ? k.dataset.shifted : k.dataset.normal;
                        if (k.textContent.length === 1) k.textContent = newChar;
                        k.dataset.char = newChar.toLowerCase();
                    }
                });
            }

            setupListeners() {
                document.getElementById('btn-start-game').onclick = () => this.startGame();
                this.ui.buttons.menu.onclick = () => this.toMenu();
                document.getElementById('btn-options').onclick = () => { this.togglePause(true); this.showScreen('options'); };
                document.getElementById('btn-close-options').onclick = () => this.closeOptions();
                this.ui.users.hedy.onclick = () => this.switchUser('Hedy');
                this.ui.users.keno.onclick = () => this.switchUser('Keno');
                this.ui.inputs.volMusic.oninput = (e) => this.audio.setVolume('music', e.target.value);
                this.ui.inputs.volSfx.oninput = (e) => this.audio.setVolume('sfx', e.target.value);
                this.ui.buttons.loop.onclick = () => { this.isLooping = !this.isLooping; this.toggleBtnVisual(this.ui.buttons.loop, this.isLooping); };
                this.ui.buttons.bonus.onclick = () => { this.noBonus = !this.noBonus; this.toggleBtnVisual(this.ui.buttons.bonus, !this.noBonus); };
                document.getElementById('btn-resume').onclick = () => this.togglePause();
                document.getElementById('btn-quit').onclick = () => { this.togglePause(); this.toMenu(); };
                document.getElementById('btn-modal-action').onclick = () => this.handleNextAction();
                this.ui.buttons.repeat.onclick = () => { this.ui.screens.modal.classList.add('hidden'); this.startLevel(this.currentLevelIdx); };
                this.ui.buttons.directNext.onclick = () => { 
                    this.ui.screens.modal.classList.add('hidden'); 
                    if(this.currentLevelIdx + 1 < LEVELS.length) this.startLevel(this.currentLevelIdx + 1); 
                };

                window.addEventListener('keydown', (e) => {
                    if (e.key === "Shift") this.toggleKeyboardShift(true);
                    if (e.key === "Enter") {
                        if (!this.ui.screens.start.classList.contains('hidden')) this.startGame();
                        else if (!this.ui.screens.level.classList.contains('hidden')) { /* Do nothing on enter in menu */ }
                        else if (!this.ui.screens.modal.classList.contains('hidden')) this.handleNextAction();
                    } else if (e.key === "Escape") { if (this.isGameActive || this.isPaused) this.togglePause(); }
                    else { this.handleTyping(e); }
                });
                
                window.addEventListener('keyup', (e) => {
                    if (e.key === "Shift") this.toggleKeyboardShift(false);
                    this.handleKeyUp(e);
                });
            }

            closeOptions() {
                this.audio.setSettings(this.ui.inputs.sfx.value, this.ui.inputs.bgm.value);
                this.world.setMascot(this.ui.inputs.mascot.value);
                this.world.setTheme(this.ui.inputs.theme.value);
                this.world.animMode = this.ui.inputs.anim.value;
                this.kbLayout = this.ui.inputs.kbLayout.value;
                this.kbColor = this.ui.inputs.kbColor.value;
                this.kbError = this.ui.inputs.kbError.value;
                this.explEnabled = this.ui.inputs.expl.value; 
                this.initKeyboardUI(); 
                this.resumeGameAfterMenu();
            }

            resumeGameAfterMenu() { 
                if(this.isGameActive) { 
                    this.isPaused = false; 
                    this.world.container.style.filter = "none"; 
                    this.ui.bgContainer.style.display = 'none'; 
                    this.initBackgroundEffect('none');
                    this.showScreen('game'); 
                } else { 
                    this.ui.bgContainer.style.display = 'block'; 
                    this.initBackgroundEffect('rain'); 
                    this.showScreen('level'); 
                } 
            }
            toggleBtnVisual(btn, isActive) { if (isActive) { btn.classList.remove('toggle-off'); btn.classList.add('toggle-on'); } else { btn.classList.remove('toggle-on'); btn.classList.add('toggle-off'); } }
            
            startGame() { this.audio.init(); this.showScreen('level'); }
            toMenu() { 
                this.isGameActive = false; this.isPaused = false; 
                this.ui.bgContainer.style.display = 'block'; 
                this.initBackgroundEffect('rain'); 
                this.showScreen('level'); 
            }
            togglePause(forcePause = false) {
                if (!this.isGameActive && !this.isPaused && !forcePause) return;
                if (forcePause) this.isPaused = false;
                this.isPaused = !this.isPaused;
                if (this.isPaused) { this.ui.screens.pause.classList.remove('hidden'); this.world.container.style.filter = "blur(5px)"; } 
                else { this.ui.screens.pause.classList.add('hidden'); this.world.container.style.filter = "none"; }
            }

            showScreen(name) {
                Object.values(this.ui.screens).forEach(el => el.classList.add('hidden'));
                if (name === 'game') this.ui.screens.game.classList.remove('hidden');
                else if (name === 'level') { this.renderLevelSelect(); this.ui.screens.level.classList.remove('hidden'); }
                else if (name === 'start') this.ui.screens.start.classList.remove('hidden');
                else if (name === 'modal') this.ui.screens.modal.classList.remove('hidden');
                else if (name === 'pause') this.ui.screens.pause.classList.remove('hidden');
                else if (name === 'options') this.ui.screens.options.classList.remove('hidden');
            }

            startLevel(index) {
                if (index >= LEVELS.length) index = 0;
                this.currentLevelIdx = index;
                this.targetString = LEVELS[index].content;
                this.currentIndex = 0; this.score = 0; this.errors = 0;
                this.streak = 0; 
                this.isGameActive = false; 
                this.typedHistory = [];
                this.ui.bgContainer.style.display = 'none';
                this.initBackgroundEffect('none');
                this.world.container.style.filter = "none";
                this.world.resetChase(); 
                const lvlName = `Level ${LEVELS[index].id}`;
                this.ui.buttons.menu.innerHTML = `üè† ${lvlName}`;
                this.ui.flash.style.opacity = "1";
                this.ui.flashTitle.textContent = lvlName;
                let count = 3;
                this.ui.flashCount.textContent = count;
                const countdown = setInterval(() => {
                    count--;
                    if(count > 0) {
                        this.ui.flashCount.textContent = count;
                    } else if (count === 0) {
                        this.ui.flashCount.textContent = "LOS!";
                        this.isGameActive = true;
                        this.startTime = Date.now();
                    } else {
                        clearInterval(countdown);
                        this.ui.flash.style.opacity = "0";
                    }
                }, 1000);
                this.updateDisplay(false); this.showScreen('game'); this.highlightKey(this.targetString[0]);
            }

            triggerCharExplosion() {
                const el = this.ui.display.current;
                const rect = el.getBoundingClientRect();
                const center = { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
                const colors = ['#FF9AA2', '#B5EAD7', '#FFB7B2', '#C7CEEA', '#FFF176'];
                let count = 12; let scaleBase = 1; let velocityBase = 100;
                if (this.explEnabled === 'ultra') { count = 100; velocityBase = 250; } else if (this.explEnabled === 'grow') { count = 12 + Math.min(this.streak * 2, 50); scaleBase = 1 + Math.min(this.streak * 0.1, 3); velocityBase = 100 + Math.min(this.streak * 10, 200); }
                for(let i=0; i<count; i++) {
                    const p = document.createElement('div');
                    p.classList.add('particle');
                    document.body.appendChild(p);
                    p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    p.style.left = center.x + 'px';
                    p.style.top = center.y + 'px';
                    const angle = Math.random() * Math.PI * 2;
                    const velocity = 50 + Math.random() * velocityBase;
                    const tx = Math.cos(angle) * velocity; 
                    const ty = Math.sin(angle) * velocity;
                    p.animate([
                        { transform: `translate(0,0) scale(${scaleBase})`, opacity: 1 },
                        { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
                    ], { duration: 500 + Math.random() * 200, easing: 'ease-out' }).onfinish = () => p.remove();
                }
            }

            handleTyping(e) {
                if (!this.isGameActive || this.isPaused) return;
                let char = e.key; const keyEl = this.findKeyElement(char); const expected = this.targetString[this.currentIndex];
                if (char === expected) {
                    if (keyEl) keyEl.classList.add('pressed');
                    this.typedHistory.push({ char: char, type: 'correct' });
                    this.audio.playCorrect(this.currentIndex); this.score += 10; this.streak++; 
                    if(this.explEnabled !== 'off') this.triggerCharExplosion();
                    this.currentIndex++; this.world.triggerReaction(); this.world.stepChase('player'); 
                    if (this.currentIndex >= this.targetString.length) { 
                        this.levelComplete(); 
                    } else { 
                        this.updateDisplay(this.explEnabled !== 'off'); 
                        this.highlightKey(this.targetString[this.currentIndex]); 
                    }
                } else {
                    if (char.length === 1) { 
                        this.errors++; this.streak = 0; 
                        if (keyEl && this.kbError === 'flash') {
                            keyEl.classList.add('error-flash');
                            setTimeout(() => keyEl.classList.remove('error-flash'), 200);
                        } else if(keyEl) {
                            keyEl.classList.add('pressed');
                        }
                        this.typedHistory.push({ char: char, type: 'wrong' });
                        this.audio.playWrong(); this.ui.display.current.classList.add('shake'); setTimeout(() => this.ui.display.current.classList.remove('shake'), 300); 
                        this.world.stepChase('npc'); 
                    }
                }
                this.ui.display.score.innerText = this.score;
            }

            handleKeyUp(e) { const keyEl = this.findKeyElement(e.key); if (keyEl) keyEl.classList.remove('pressed'); }
            findKeyElement(char) { 
                const lower = char.toLowerCase(); 
                if (char === " ") return document.querySelector('.key.space'); 
                try { return document.querySelector(`.key[data-char='${lower}']`); } catch(e) { return null; }
            }
            highlightKey(char) { 
                document.querySelectorAll('.key.active').forEach(el => el.classList.remove('active')); 
                const el = this.findKeyElement(char); 
                if (el) el.classList.add('active'); 
            }
            updateDisplay(animate = false) {
                const current = this.targetString[this.currentIndex];
                const next = this.targetString.substring(this.currentIndex + 1, this.currentIndex + 10);
                const charEl = this.ui.display.current;
                charEl.textContent = current === " " ? "‚ê£" : current;
                this.ui.display.next.textContent = next.replace(/ /g, "‚ê£");
                charEl.classList.remove('char-appear');
                if(animate) { void charEl.offsetWidth; charEl.classList.add('char-appear'); }
                const pct = (this.currentIndex / this.targetString.length) * 100;
                this.ui.display.bar.style.width = `${pct}%`;
            }

            spawnModalEffects(stars) {
                const colors = ['#FFD700', '#FF4500', '#1E90FF', '#32CD32'];
                const count = stars * 10 + 20; 
                for(let i=0; i<count; i++) {
                    const p = document.createElement('div');
                    p.classList.add('particle', 'star');
                    p.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
                    document.getElementById('modal-screen').appendChild(p);
                    p.style.left = '50%'; p.style.top = '30%';
                    const angle = Math.random() * Math.PI * 2;
                    const vel = 100 + Math.random() * 200;
                    p.animate([
                        { transform: 'translate(-50%, -50%) scale(0)', opacity: 1 },
                        { transform: `translate(calc(-50% + ${Math.cos(angle)*vel}px), calc(-50% + ${Math.sin(angle)*vel + 100}px)) rotate(${Math.random()*360}deg)`, opacity: 0 }
                    ], { duration: 1000 + Math.random()*1000, easing: 'ease-out' }).onfinish = () => p.remove();
                }
            }

            levelComplete() {
                this.isGameActive = false;
                const totalChars = this.targetString.length;
                const durationMinutes = (Date.now() - this.startTime) / 60000;
                const cpm = totalChars / durationMinutes;
                const targetCPM = 60; 
                let speedPct = Math.round((cpm / targetCPM) * 100); if(speedPct > 100) speedPct = 100;
                const totalKeystrokes = totalChars + this.errors;
                let accPct = 100; if(totalKeystrokes > 0) accPct = Math.round(((totalChars) / totalKeystrokes) * 100); if(accPct < 0) accPct = 0;
                
                let stars = 1; 
                if (speedPct >= 40 && accPct >= 40) stars = 2; 
                if (speedPct >= 60 && accPct >= 60) stars = 3; 
                if (speedPct >= 80 && accPct >= 80) stars = 4; 
                if (speedPct >= 100 && accPct >= 100) stars = 5;

                const lvlId = LEVELS[this.currentLevelIdx].id;
                const oldScore = this.scores[lvlId] || 0;
                if(stars > oldScore) {
                    this.scores[lvlId] = stars;
                    localStorage.setItem(`tastenZauberScores_${this.currentUser}`, JSON.stringify(this.scores));
                }
                
                if(stars === 5) this.audio.playSuperWin(); else this.audio.playWin();
                this.spawnModalEffects(stars);

                this.ui.bgContainer.style.display = 'block';
                this.initBackgroundEffect('animals', lvlId); 

                const modalTitle = document.getElementById('modal-title');
                const starDisplay = document.getElementById('result-stars');
                const barSpeed = document.getElementById('bar-speed');
                const barAcc = document.getElementById('bar-acc');
                const lblSpeed = document.getElementById('lbl-speed');
                const lblAcc = document.getElementById('lbl-acc');
                const modalBtn = document.getElementById('btn-modal-action');
                const textDisplay = document.getElementById('result-text-display');
                
                const btnDirect = this.ui.buttons.directNext;
                const nextLvlIdx = this.currentLevelIdx + 1;
                let nextLocked = false;
                if(nextLvlIdx % 10 === 0 && nextLvlIdx < LEVELS.length) {
                    const requiredBlock = Math.floor(nextLvlIdx / 10);
                    if(requiredBlock > this.checkBlockUnlock()) nextLocked = true; 
                }

                if (nextLvlIdx < LEVELS.length && !nextLocked) {
                    btnDirect.classList.remove('hidden');
                    btnDirect.innerText = `Zu Level ${LEVELS[nextLvlIdx].id}`;
                } else {
                    btnDirect.classList.add('hidden'); 
                }

                modalTitle.innerText = stars === 5 ? "Perfekt! Legend√§r!" : "Level geschafft!";
                let starStr = ""; 
                if(stars===1) starStr = "‚≠ê"; 
                if(stars===2) starStr = "‚≠ê‚≠ê"; 
                if(stars===3) starStr = "‚≠ê‚≠ê‚≠ê"; 
                if(stars===4) starStr = "‚≠ê‚≠ê‚≠ê‚≠ê";
                if(stars===5) starStr = "üåüüåüüåüüåüüåü";
                
                starDisplay.innerText = starStr;
                starDisplay.className = "result-stars pop-stars" + (stars === 5 ? " five-stars" : "");
                
                lblSpeed.innerText = speedPct + "%"; lblAcc.innerText = accPct + "%";
                barSpeed.style.width = "0%"; barAcc.style.width = "0%";
                setTimeout(() => { barSpeed.style.width = speedPct + "%"; barAcc.style.width = accPct + "%"; }, 100);
                
                textDisplay.innerHTML = "";
                this.typedHistory.forEach(item => { const span = document.createElement('span'); span.textContent = item.char; span.className = item.type === 'correct' ? 'res-char correct' : 'res-char wrong'; textDisplay.appendChild(span); });
                
                if (this.isLooping) modalBtn.innerText = "Wiederholen (Enter)"; else if (this.noBonus) modalBtn.innerText = "N√§chstes Level (Enter)"; else modalBtn.innerText = "Bonus spielen (Enter)";
                this.showScreen('modal');
            }

            handleNextAction() {
                this.ui.screens.modal.classList.add('hidden');
                
                const isLooping = document.getElementById('btn-loop').classList.contains('toggle-on');
                if (isLooping) {
                    this.startLevel(this.currentLevelIdx);
                    return;
                }

                const isBonusOn = document.getElementById('btn-bonus').classList.contains('toggle-on');
                
                if (isBonusOn) {
                    // SAVE DATA FOR BONUS PAGE
                    const lvlKeys = LEVELS[this.currentLevelIdx].keys;
                    localStorage.setItem('tastenZauber_bonusKeys', lvlKeys);
                    // Redirect
                    window.location.href = 'bonus.html';
                } else {
                    if(!this.ui.buttons.directNext.classList.contains('hidden')) {
                        this.startLevel(this.currentLevelIdx + 1); 
                    } else {
                        this.showScreen('level');
                    }
                }
            }

            startMiniGame() {
                // Legacy function, effectively bypassed by redirect
                this.showScreen('none');
                this.ui.bgContainer.style.display = 'none';
                this.initBackgroundEffect('none');
                this.ui.miniUi.classList.remove('hidden'); 
                this.ui.bonusLetter.classList.add('visible'); 

                const canvas = document.getElementById('mini-game-canvas'); 
                canvas.style.display = 'block';
                const ctx = canvas.getContext('2d'); 
                
                this.world.enterBonusMode();

                // ... (rest of old logic hidden)
            }
        }
        window.onload = () => { const app = new Game(); };
    </script>
</body>
</html>
