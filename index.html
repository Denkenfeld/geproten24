<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hedy's TastenZauber</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        /* --- CSS STYLING --- */
        :root { --primary: #FF9AA2; --secondary: #B5EAD7; --accent: #FFB7B2; --text: #6d5c6d; --dark: #4A404F; --keyboard-bg: rgba(255, 255, 255, 0.85); --key-bg: #fff; --key-active: #C7CEEA; --key-error: #FFF176; --btn-inactive: #e0e0e0; --gold: #FFD700; }
        body { margin: 0; overflow: hidden; font-family: 'Fredoka', sans-serif; background-color: #E2F0CB; color: var(--text); user-select: none; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; transition: filter 0.3s; }
        #global-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 90; background: linear-gradient(120deg, #FF9AA2, #FFB7B2, #FFDAC1, #E2F0CB, #B5EAD7, #C7CEEA); background-size: 400% 400%; animation: rainbowBG 15s ease infinite; pointer-events: none; transition: filter 0.5s; }
        @keyframes rainbowBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .rainbow-spin { animation: rainbowSpin 1s linear infinite !important; filter: hue-rotate(90deg) contrast(1.5); }
        @keyframes rainbowSpin { 0% { background-position: 0% 50%; } 100% { background-position: 400% 50%; } }
        #bg-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.4; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        .ui-element { pointer-events: auto; }
        header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.3); backdrop-filter: blur(5px); }
        .header-left, .header-right { display: flex; gap: 10px; align-items: center; }
        .vol-control { display: flex; flex-direction: column; align-items: center; margin-right: 10px; }
        .vol-control input { width: 80px; cursor: pointer; }
        .vol-control span { font-size: 0.8rem; font-weight: bold; }
        .score-box { background: white; padding: 5px 15px; border-radius: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 1.1rem; font-weight: 600; display: flex; gap: 10px; align-items: center; }
        .progress-container { width: 200px; height: 15px; background: rgba(200,200,200,0.3); border-radius: 10px; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #FF9AA2, #FFB7B2); width: 0%; transition: width 0.2s; }
        #target-display { position: absolute; top: 15%; left: 50%; transform: translate(-50%, 0); text-align: center; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        #current-char { order: 1; font-size: 10rem; color: white; text-shadow: 0 4px 15px rgba(0,0,0,0.2); font-weight: bold; line-height: 1; animation: float 3s ease-in-out infinite; }
        .char-appear { animation: popInChar 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards !important; }
        @keyframes popInChar { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .particle { position: absolute; width: 10px; height: 10px; border-radius: 50%; pointer-events: none; z-index: 100; }
        .particle.star { clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); background: gold; }
        #next-chars { order: 2; font-size: 2rem; color: rgba(255,255,255,0.9); letter-spacing: 5px; background: rgba(0, 0, 0, 0.2); padding: 5px 20px; border-radius: 20px; backdrop-filter: blur(2px); }
        #keyboard-wrapper { margin-bottom: 30px; display: flex; justify-content: center; width: 100%; }
        .keyboard { background: var(--keyboard-bg); padding: 20px; border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); backdrop-filter: blur(5px); display: flex; flex-direction: column; gap: 8px; width: 950px; transition: width 0.3s; }
        .keyboard.macbook { width: 1100px; } 
        .row { display: flex; justify-content: center; gap: 8px; }
        .key { width: 52px; height: 52px; background: var(--key-bg); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 0 #ddd; color: var(--dark); transition: all 0.1s; position: relative; }
        .key.wide { width: 80px; } .key.space { width: 350px; } .key.cmd { width: 70px; font-size: 0.9rem; }
        .key.active { background: var(--primary) !important; color: white !important; box-shadow: 0 3px 0 #D68C94 !important; transform: translateY(2px); border: 2px solid white; }
        .key.pressed { transform: translateY(4px); box-shadow: 0 0 0 #ddd; }
        .key.error-flash { background-color: var(--key-error) !important; box-shadow: 0 0 10px var(--key-error); transform: scale(1.1); transition: all 0.1s; }
        .keyboard.fingers .key { border-bottom: 3px solid rgba(0,0,0,0.1); }
        .keyboard.fingers .f-pinky { background-color: #FFCDD2; } .keyboard.fingers .f-ring { background-color: #FFE0B2; } .keyboard.fingers .f-mid { background-color: #FFF9C4; } .keyboard.fingers .f-idx-l { background-color: #C8E6C9; } .keyboard.fingers .f-idx-r { background-color: #B3E5FC; } .keyboard.fingers .hand-split { border-right: 2px dashed #999; margin-right: 4px; }
        .overlay-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        #start-screen { background: transparent; } #level-screen { background: transparent; } #modal-screen { background: transparent !important; }
        .hidden { display: none !important; }
        h1 { font-size: 4rem; color: var(--primary); margin: 0; text-shadow: 2px 2px 0 #fff; }
        #start-screen h1, #level-screen h1, #modal-screen h1 { color: white; text-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #start-screen h2 { color: white; text-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn { background: var(--secondary); border: none; padding: 12px 30px; border-radius: 50px; font-size: 1.3rem; font-family: 'Fredoka', sans-serif; font-weight: bold; color: var(--dark); cursor: pointer; margin: 8px; box-shadow: 0 4px 0 #8AC6B3; transition: transform 0.1s; }
        .btn:hover { transform: scale(1.05); } .btn:active { transform: scale(0.95) translateY(4px); box-shadow: none; }
        .btn.small { padding: 8px 15px; font-size: 0.9rem; box-shadow: 0 2px 0 #8AC6B3; }
        .btn.toggle-on { background: var(--secondary); } .btn.toggle-off { background: var(--btn-inactive); color: #888; box-shadow: 0 2px 0 #ccc; }
        .user-switch { display: flex; gap: 10px; margin-bottom: 20px; background: rgba(255,255,255,0.5); padding: 5px; border-radius: 30px; backdrop-filter: blur(5px); }
        .user-btn { padding: 10px 30px; border-radius: 25px; border: none; cursor: pointer; font-weight: bold; font-size: 1.2rem; background: transparent; color: #fff; transition: all 0.2s; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .user-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-shadow: none; }
        .star-header { background: white; padding: 10px 25px; border-radius: 50px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 1.4rem; font-weight: bold; color: var(--dark); display: flex; align-items: center; gap: 15px; }
        .star-header span { display: flex; align-items: center; gap: 5px; }
        .star-header .gold { color: gold; text-shadow: 0 1px 1px rgba(0,0,0,0.2); }
        .level-grid { display: flex; flex-direction: column; gap: 20px; margin-top: 10px; max-height: 55vh; overflow-y: auto; padding: 15px; width: 85%; }
        .level-block { background: rgba(255,255,255,0.3); padding: 15px; border-radius: 20px; backdrop-filter: blur(5px); }
        .level-block-title { font-size: 1.5rem; color: white; margin-bottom: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.2); text-align: left; padding-left: 10px; display: flex; justify-content: space-between; align-items: center; }
        .level-block-content { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .level-btn { background: #fff; border: 3px solid rgba(0,0,0,0.05); padding: 10px; border-radius: 15px; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05); opacity: 0.9; position: relative; overflow: hidden; }
        .level-btn:hover { transform: scale(1.05); opacity: 1; z-index: 10; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .level-btn.active-level { border: 4px solid #fff; transform: scale(1.1); z-index: 2; box-shadow: 0 0 15px rgba(255,255,255,0.8); }
        .level-btn.locked { filter: grayscale(1); opacity: 0.6; cursor: not-allowed; pointer-events: none; }
        .level-btn.locked::after { content: "üîí"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; opacity: 0.5; }
        .level-stars { color: gold; font-size: 1rem; text-shadow: 0 1px 1px rgba(0,0,0,0.2); }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; background: white; padding: 30px; border-radius: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-height: 70vh; overflow-y: auto; width: 700px; }
        .setting-group label { font-weight: bold; color: var(--primary); }
        select { width: 100%; padding: 8px; border-radius: 8px; border: 2px solid var(--secondary); font-family: 'Fredoka', sans-serif; }
        .grid-full { grid-column: span 2; border-top: 1px solid #eee; padding-top: 10px; }
        #level-flash { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 6rem; color: var(--primary); font-weight: bold; opacity: 0; pointer-events: none; z-index: 200; text-shadow: 2px 2px 0 #fff, 0 0 20px rgba(255,255,255,0.8); text-align: center; width: 100%; transition: opacity 0.5s; display: flex; flex-direction: column; align-items: center;}
        #flash-countdown { font-size: 4rem; color: #4A404F; margin-top: 10px; }
        #minigame-ui { position: absolute; top: 20px; right: 20px; z-index: 60; }
        .result-stats { width: 500px; background: rgba(255,255,255,0.95); padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); backdrop-filter: blur(5px); }
        .bar-bg { width: 100%; height: 15px; background: #eee; border-radius: 10px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: width 1s ease-out; }
        .bar-fill.green { background-color: #4CAF50; } .bar-fill.blue { background-color: #42A5F5; }
        .result-text-box { width: 100%; height: 80px; overflow-y: auto; background: #f4f4f4; border-radius: 10px; padding: 10px; margin-top: 15px; text-align: left; font-family: monospace; font-size: 1.1rem; border: 2px solid #eee; white-space: pre-wrap; }
        .res-char.correct { color: #4CAF50; } .res-char.wrong { color: #FF5252; text-decoration: line-through; font-weight: bold; }
        .result-stars { font-size: 4rem; margin: 10px 0; display: inline-block; }
        .pop-stars { animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; text-shadow: 0 0 20px gold, 0 0 10px orange; }
        .five-stars { color: var(--gold); animation: pulseGold 1s infinite; text-shadow: 0 0 30px var(--gold); }
        @keyframes pulseGold { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 70% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .shake { animation: shake 0.3s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    <div id="global-bg"><canvas id="bg-canvas"></canvas></div>
    <div id="level-flash"><div id="flash-title">Level 1</div><div id="flash-countdown"></div></div>
    <div id="ui-layer" class="hidden">
        <header class="ui-element">
            <div class="header-left"><button class="btn small" id="btn-menu">üè† Level 1</button><button class="btn small" id="btn-options">üîß Optionen</button></div>
            <div class="header-right">
                <div class="vol-control"><span>üéµ Musik</span><input type="range" id="vol-music" min="0" max="100" value="80"></div>
                <div class="vol-control"><span>üîä Effekte</span><input type="range" id="vol-sfx" min="0" max="100" value="20"></div>
                <div class="score-box"><span>‚≠ê <span id="score-val">0</span></span><div class="progress-container"><div class="progress-bar" id="prog-bar"></div></div></div>
                <button class="btn small toggle-off" id="btn-loop">üîÅ Loop</button>
                <button class="btn small toggle-on" id="btn-bonus">üéÅ Bonus</button>
            </div>
        </header>
        <div id="target-display"><div id="current-char">Start!</div><div id="next-chars"></div></div>
        <div id="keyboard-wrapper" class="ui-element"><div class="keyboard" id="onscreen-keyboard"></div></div>
    </div>
    <div id="start-screen" class="overlay-screen"><h1>Hedy's TastenZauber</h1><h2>Lerne Tippen mit dem magischen Fuchs!</h2><button class="btn" id="btn-start-game">Los geht's! (Enter)</button></div>
    <div id="level-screen" class="overlay-screen hidden"><h1>Level Auswahl</h1><div class="user-switch"><button class="user-btn active" id="user-hedy">Hedy</button><button class="user-btn" id="user-keno">Keno</button></div><div id="star-summary" class="star-header"><span>Gesamt: <span class="gold">‚≠ê</span> <span id="total-stars-val">0</span></span><span style="font-size: 1rem; opacity: 0.8;">|</span><span id="next-unlock-info">N√§chstes Ziel: 30 ‚≠ê</span></div><div class="level-grid" id="level-container"></div></div>
    <div id="options-screen" class="overlay-screen hidden" style="background: rgba(255,255,255,0.95);"><h1>Optionen</h1><div class="settings-grid">
        <div class="setting-group"><label>‚å®Ô∏è Layout</label><select id="sel-kb-layout"><option value="simple">Einfach</option><option value="macbook" selected>MacBook</option></select></div>
        <div class="setting-group"><label>üé® Farben</label><select id="sel-kb-color"><option value="standard">Wei√ü</option><option value="fingers" selected>Bunt</option></select></div>
        <div class="setting-group"><label>‚ö†Ô∏è Fehler</label><select id="sel-kb-error"><option value="subtle">Dezent</option><option value="flash" selected>Aufleuchten</option></select></div>
        <div class="setting-group"><label>üí• Effekt</label><select id="sel-expl"><option value="on">Standard</option><option value="ultra">ULTRA üî•</option><option value="grow" selected>Grow üå±</option><option value="off">Aus</option></select></div>
        <div class="setting-group"><label>ü§∏ Animation</label><select id="sel-anim"><option value="jump">Springen</option><option value="chase">Jagd</option><option value="spin">Drehen</option><option value="wink">Zwinkern</option><option value="mouth">Sprechen</option><option value="grow">Wachsen</option><option value="shrink">Schrumpfen</option><option value="random">Zufall</option></select></div>
        <div class="setting-group"><label>üîä Sound</label><select id="sel-sfx"><option value="click" selected>Klick</option><option value="piano">Piano</option><option value="8bit">8-Bit</option><option value="bubble">Blubber</option><option value="magic">Magie</option><option value="robot">Roboter</option><option value="off">Aus</option></select></div>
        <div class="setting-group"><label>üéµ Musik</label><select id="sel-bgm"><option value="keychill" selected>KeyChill (MP3)</option><option value="lullaby">Lullaby</option><option value="off">Aus</option></select></div>
        <div class="setting-group"><label>ü¶Ñ Tier</label><select id="sel-mascot"><option value="fox">Fuchs</option><option value="unicorn">Einhorn</option><option value="bear">B√§r</option><option value="bunny">Hase</option><option value="cat">Katze</option><option value="dog_billy">Billy</option><option value="robot">Roboter</option><option value="random">Zufall</option></select></div>
        <div class="setting-group"><label>üåç Welt</label><select id="sel-theme"><option value="forest">Wald</option><option value="candy">S√º√ü</option><option value="ice">Eis</option><option value="space">All</option><option value="underwater">Meer</option><option value="random">Zufall</option></select></div>
    </div><button class="btn" id="btn-close-options">Zur√ºck</button></div>
    <div id="pause-screen" class="overlay-screen hidden"><h1>Pause</h1><button class="btn" id="btn-resume">Weiter (Esc)</button><button class="btn small" id="btn-quit">Zum Men√º</button></div>
    <div id="modal-screen" class="overlay-screen hidden"><h1 id="modal-title">Super!</h1><div class="result-stars" id="result-stars"></div><div class="result-stats"><div class="stat-row"><div class="stat-label"><span>Tempo</span> <span id="lbl-speed"></span></div><div class="bar-bg"><div class="bar-fill green" id="bar-speed"></div></div></div><div class="stat-row"><div class="stat-label"><span>Genauigkeit</span> <span id="lbl-acc"></span></div><div class="bar-bg"><div class="bar-fill blue" id="bar-acc"></div></div></div><div class="stat-row"><div class="stat-label"><span>Dein Text:</span></div><div class="result-text-box" id="result-text-display"></div></div></div><button class="btn" id="btn-modal-action">Weiter (Enter)</button><button class="btn" id="btn-repeat-level" style="margin-left:5px;">Wiederholen</button><button class="btn small" id="btn-direct-next" style="margin-top: 5px; background-color: rgba(255,255,255,0.8);">Zu Level X</button></div>

    <script>
        // ... (LEVELS data remains the same) ...
        const generateLevels = () => {
             const levels = [];
             const add = (id, name, keys, content) => levels.push({ id, name, keys, content });
             // Shortened for brevity in this display, assumes you have the full list
             add(1, "Grundstellung: f j", "fj", "fff jjj fjfj jfjf fj jf ff jj fff jjj fjfj");
             add(2, "Grundstellung: d k", "fjdk", "ddd kkk dkdk kdkd dj fj dk kd fd jd kf jf");
             add(3, "Grundstellung: s l", "fjdksl", "sss lll slsl lsls ds ks fs js as la sl");
             add(4, "Grundstellung: a √∂", "fjdksla√∂", "aaa √∂√∂√∂ a√∂a√∂ √∂a√∂a sa la fa ja al √∂s l√∂");
             add(5, "Mitte: g h", "all", "ggg hhh ghgh hghg fg jh dg kh ag √∂h gl hl");
             add(6, "W√∂rter Grundreihe", "all", "hallo da als das glas ja saal fass hasse kahl");
             add(7, "S√§tze Grundreihe", "all", "Hallo Saskia. Das Glas ist da. Ja, das ist alles.");
             add(8, "Mix Grundreihe", "all", "asdf jkl√∂ ghjk aass ddff jjkk ll√∂√∂ fghj");
             add(9, "Speed Grundreihe", "all", "fad gas jagd hals kaff saal lass fall das");
             add(10, "Test Grundreihe", "all", "Saskia ass das Glas. Hallo Papa. Ja, das ist das Haus.");
             add(11, "Oberreihe: e i", "all ei", "eee iii ei ie see fee eil idee seele eil");
             add(12, "W√∂rter mit e i", "all ei", "die idee see eis teil lied hier diese");
             add(13, "Oberreihe: r t", "all eirt", "rrr ttt tr rt er te treter rat tat tier");
             add(14, "W√∂rter mit r t", "all eirt", "treten rate tasten rest dort tier drei");
             add(15, "Oberreihe: u", "all eirtu", "uuu tut rut urt hut hutte tau durst");
             add(16, "W√∂rter mit u", "all eirtu", "hut tutu tau rustet durst turm stunde");
             add(17, "Oberreihe: z w o", "all eirtuzwo", "zzz www ooo zu wo ort wort toll zwei");
             add(18, "W√∂rter mit z w o", "all eirtuzwo", "zwei wort wo ort zoo wert witz oz");
             add(19, "Oberreihe: q p √º", "all eirtuzwoqp√º", "qqq ppp √º√º√º quer post qual pott t√ºr");
             add(20, "W√∂rter mit q p √º", "all eirtuzwoqp√º", "quer pferd post √ºben t√ºr fr√ºh gr√ºn");
             add(21, "Mix Oberreihe", "all", "trete quip zeit wort t√ºr post quer");
             add(22, "Test Oberreihe", "all", "Die T√ºr ist zu. Zwei Pferde laufen quer √ºber die Stra√üe.");
             add(23, "Unterreihe: c v", "all", "ccc vvv cv vc victor cave viel vater");
             add(24, "W√∂rter mit c v", "all", "victor cave virus vor viel vater");
             add(25, "Unterreihe: b n", "all", "bbb nnn bn nb band nein bin nass");
             add(26, "W√∂rter mit b n", "all", "band nein bin nass name bank");
             add(27, "Unterreihe: m y", "all", "mmm yyy mutter yoga yacht typ");
             add(28, "W√∂rter mit m y", "all", "mutter mama mehr yoga typ yacht");
             add(29, "Unterreihe: x √ü", "all", "xxx √ü√ü√ü box taxi stra√üe gro√ü");
             add(30, "W√∂rter mit x √ü", "all", "box fax taxi mix stra√üe fu√ü gro√ü");
             add(31, "Mix Unterreihe", "all", "victor yoga stra√üe name box mutter");
             add(32, "Test Unterreihe", "all", "Victor besucht die Gro√ümutter in der Yachtstra√üe.");
             add(33, "Gro√üschreibung Intro", "all", "Hallo. Das Haus. Mama und Papa. Ja!");
             add(34, "Satzanf√§nge", "all", "Die Familie ist gl√ºcklich. Hedy lacht. Keno spielt.");
             add(35, "Frage und Ausrufe", "all", "Wer ist da? Super! Toll gemacht! Wie sch√∂n!");
             add(36, "Anf√ºhrungszeichen", "all", "Mama sagt: ‚ÄûKomm essen!‚Äú Papa ruft: ‚ÄûJa, lecker!‚Äú");
             add(37, "Gemischte S√§tze", "all", "Hedy fragt: ‚ÄûDarf ich?‚Äú Keno antwortet: ‚ÄûJa!‚Äú");
             add(38, "L√§ngere S√§tze", "all", "Die Familie geht spazieren. ‚ÄûWie sch√∂n!‚Äú, sagt Mama.");
             add(39, "Mix Gro√ü/Klein", "all", "Papa liest vor. ‚ÄûDas ist spannend‚Äú, fl√ºstert Hedy.");
             add(40, "Test Gro√üschreibung", "all", "‚ÄûHallo!‚Äú, ruft Keno. ‚ÄûKommt spielen!‚Äú, sagt Hedy fr√∂hlich.");
             add(41, "Zahlen 0-9", "all 0123456789", "111 222 333 444 555 666 777 888 999 000 123 456");
             add(42, "Einfache Rechnungen", "all", "1+1=2 3+4=7 5-2=3 10*2=20 15/3=5");
             add(43, "Telefonnummern", "all", "0176-1234567 030-888888 0151-23456789");
             add(44, "Zeichen: + - * / =", "all", "2+3=5 10-4=6 3*7=21 12/4=3");
             add(45, "Zeichen: ( )", "all", "(Hallo) (1+2)*3 (Hedy und Keno)");
             add(46, "Zeichen: @ ‚Ç¨", "all", "info@beispiel.de 9,99‚Ç¨ 100‚Ç¨ 0,50‚Ç¨");
             add(47, "Jahre und Daten", "all", "13.12.2025 01.01.2026 Hedy ist 8 Jahre alt.");
             add(48, "Gemischte Zahlen", "all", "Keno hat 12 Punkte. Hedy 15. Super!");
             add(49, "Mix Zahlen/Zeichen", "all", "(+49) 030/123456 info@familie.de");
             add(50, "Test Zahlen/Zeichen", "all", "Am 13.12.2025 kostet das Spiel 19,99‚Ç¨. Tel: 0176-12345678.");
             add(51, "Fr√ºhst√ºck", "all", "Mama macht Fr√ºhst√ºck. Papa trinkt Kaffee. Hedy isst Brot. Keno mag M√ºsli. Alle sind fr√∂hlich.");
             add(52, "Im Garten", "all", "Hedy und Keno spielen im Garten. Papa wirft den Ball. Mama lacht. Der Hund bellt mit.");
             add(53, "Am Meer", "all", "Die Familie f√§hrt ans Meer. Hedy baut eine Sandburg. Keno schwimmt. Papa und Mama sonnen sich.");
             add(54, "Abendessen", "all", "Mama kocht Pasta. Papa erz√§hlt einen Witz. Hedy und Keno lachen. Es schmeckt lecker.");
             add(55, "Helfen", "all", "Hedy deckt den Tisch. Keno hilft beim Kochen. Papa r√§umt auf. Sie sind ein super Team!");
             add(56, "Zoo-Besuch", "all", "Im Zoo sehen sie Elefanten und Affen. Keno lacht √ºber die Affen. Hedy f√ºttert Ziegen.");
             add(57, "Spiel gewonnen", "all", "Keno gewinnt beim Brettspiel. Er jubelt: ‚ÄûHurra!‚Äú Hedy klatscht. Papa sagt: ‚ÄûSuper!‚Äú");
             add(58, "Bild malen", "all", "Hedy malt ein Bild der Familie. Mama h√§ngt es auf. Papa sagt: ‚ÄûDas ist wundersch√∂n!‚Äú");
             add(59, "Abendgeschichte", "all", "Papa liest vor. Hedy und Keno kuscheln sich ein. Mama bringt Kakao. Es ist gem√ºtlich.");
             add(60, "Gute Nacht", "all", "Alle gehen ins Bett. ‚ÄûGute Nacht!‚Äú, sagt Mama. ‚ÄûSchlaft sch√∂n!‚Äú, sagt Papa.");
             add(61, "Waldabenteuer", "all", "Hedy und Keno erkunden den Wald. Sie finden einen kleinen Schatz. Mama und Papa sind stolz auf die mutigen Kinder.");
             add(62, "Rad fahren lernen", "all", "Keno lernt Rad fahren. Papa h√§lt hinten fest. Pl√∂tzlich f√§hrt er allein! Alle jubeln: ‚ÄûBravo, Keno!‚Äú");
             add(63, "Kuchen backen", "all", "Hedy backt mit Mama einen Kuchen. Er duftet wunderbar. Papa und Keno essen zwei St√ºcke. ‚ÄûLecker!‚Äú, sagen sie.");
             add(64, "Picknick", "all", "Im Park machen sie Picknick. Die Sonne scheint hell. Sie essen Sandwiches und spielen Frisbee.");
             add(65, "Lustiger Drache", "all", "Hedy und Keno tr√§umen von einem freundlichen Drachen. Er fliegt mit ihnen √ºber das Haus. Mama und Papa winken von unten.");
             add(66, "Zauberblumen", "all", "Im Garten wachsen pl√∂tzlich riesige Blumen. Keno gie√üt sie. Hedy pfl√ºckt eine f√ºr Mama. Papa staunt: ‚ÄûDas ist Magie!‚Äú");
             add(67, "Superhelden", "all", "Papa ist der starke Held. Mama kann zaubern. Hedy fliegt hoch. Keno ist superschnell. Zusammen retten sie den Tag!");
             add(68, "Bauernhof", "all", "Sie besuchen einen Bauernhof. Hedy melkt eine Kuh. Keno f√ºttert K√ºken. Mama streichelt Pferde. Papa hilft beim Heu.");
             add(69, "Rieseneis", "all", "Sie essen den gr√∂√üten Eisbecher der Welt. Mit Schoko, Vanille und Erdbeere. Alle schlecken gl√ºcklich.");
             add(70, "Weihnachten", "all", "Zu Weihnachten backen sie Pl√§tzchen. Hedy dekoriert. Keno isst Teig. Mama singt. Papa schm√ºckt den Baum.");
             add(71, "Sommergrillen", "all", "Im Sommer grillen sie im Garten. Papa macht W√ºrstchen. Mama Salat. Hedy und Keno spielen bis sp√§t Verstecken.");
             add(72, "Roboter bauen", "all", "Keno baut einen Roboter aus Karton. Er tanzt lustig. Hedy lacht. Mama und Papa klatschen: ‚ÄûGenial!‚Äú");
             add(73, "Familienreise", "all", "Die Familie packt den Koffer und f√§hrt ans Meer. Sie bauen Sandburgen, schwimmen und essen Eis. Es ist das beste Abenteuer!");
             add(74, "Zaubertag", "all", "Heute ist Zaubertag! Alles wird bunt. Hedy zaubert Blumen, Keno Eis, Mama Kuchen und Papa Spielzeug. Alle tanzen vor Freude.");
             add(75, "Schatzsuche", "all", "Mit einer Schatzkarte suchen sie im Wald. Am Ende finden sie Schokoladengold! ‚ÄûHurra!‚Äú, rufen Hedy und Keno.");
             add(76, "Gro√üe Party", "all", "Zur Geburtstagsfeier kommen alle Freunde. Es gibt Kuchen, Spiele, Musik und Luftballons. Papa tanzt lustig, Mama singt mit, Hedy und Keno sind die Stars des Abends.");
             add(77, "Traumwelt", "all", "In der Traumwelt fliegen sie auf Wolken, besuchen Sterne und essen Mondkuchen. Die Familie lacht den ganzen Tag und nachts. Es ist die sch√∂nste Welt ever!");
             add(78, "Detektive", "all", "Hedy und Keno spielen Detektive. Sie suchen den verlorenen Teddy. Mit Mama und Papa finden sie ihn im Garten. ‚ÄûFall gel√∂st!‚Äú, rufen sie stolz.");
             add(79, "Weltreise", "all", "Stellt euch vor, die Familie reist um die Welt: Paris, New York, Tokio! Sie sehen den Eiffelturm, essen Pizza in Italien und Sushi in Japan. Unvergesslich!");
             add(80, "Zirkus", "all", "Sie gehen in den Zirkus. Clowns machen Witze, L√∂wen springen durch Reifen, Akrobaten fliegen hoch. Keno lacht am lautesten, Hedy staunt mit offenem Mund.");
             add(81, "Erfindung", "all", "Keno erfindet eine Maschine, die Hausaufgaben macht. Hedy testet sie. Mama und Papa sind begeistert ‚Äì bis sie nur Witze schreibt! Alle lachen herzlich.");
             add(82, "Winterzauber", "all", "Im Winter bauen sie einen Schneemann. Sie rodeln den H√ºgel hinunter. Mama macht hei√üen Kakao. Abends sitzen alle am Kamin und erz√§hlen Geschichten.");
             add(83, "Unterwasserwelt", "all", "Im Traum tauchen sie ins Meer. Sie schwimmen mit Delfinen, sehen bunte Fische und eine Schatztruhe. Papa √∂ffnet sie ‚Äì voller Schokolade!");
             add(84, "Ritter und Prinzessin", "all", "Hedy ist die mutige Prinzessin, Keno der tapfere Ritter. Sie bek√§mpfen einen freundlichen Drachen, der nur Kuscheln will. Happy End!");
             add(85, "Raumfahrt", "all", "Die Familie baut eine Rakete und fliegt zum Mond. Sie springen in niedriger Schwerkraft, pflanzen eine Flagge und essen Mondk√§se. Wow!");
             add(86, "Magischer Wald", "all", "Im magischen Wald sprechen die Tiere. Ein Fuchs zeigt ihnen den Weg zu einer Lichtung mit tanzenden Feen. Mama tanzt mit, Papa filmt alles.");
             add(87, "Zeitreise", "all", "Mit einer Zeitmaschine reisen sie zu Dinosauriern. Sie sehen T-Rex und fliegen auf einem Pterodactyl. Zur√ºck in der Gegenwart erz√§hlen sie alles.");
             add(88, "Olympiade", "all", "Die Familie macht eine eigene Olympiade: Laufen, Springen, Ballwerfen. Jeder gewinnt eine Medaille. ‚ÄûWir sind alle Sieger!‚Äú, sagt Papa.");
             add(89, "Geheimversteck", "all", "Hedy und Keno bauen ein geheimes Baumhaus. Nur die Familie darf rein. Dort lesen sie Comics, essen Kekse und planen neue Abenteuer.");
             add(90, "Das gr√∂√üte Fest", "all", "Am Jahresende feiern sie das gr√∂√üte Fest. Mit Feuerwerk, Geschenken, Liedern und Umarmungen. Die beste Familie der Welt!");
             add(91, "Das gro√üe Abenteuerbuch", "all", "Es war einmal eine Familie: Mama, Papa, Hedy und Keno. Sie lebten in einem sch√∂nen Haus mit gro√üem Garten. Eines Tages fanden die Kinder eine alte Schatzkarte hinter dem Schrank. ‚ÄûLasst uns den Schatz suchen!‚Äú, rief Keno aufgeregt. Mama und Papa lachten: ‚ÄûNa klar, Abenteuerzeit!‚Äú Sie packten Rucks√§cke mit Proviant und machten sich auf den Weg in den nahegelegenen Wald.");
             add(92, "Fortsetzung Schatzsuche", "all", "Im Wald folgten sie der Karte. Zuerst kamen sie an einen Bach. ‚ÄûWir brauchen eine Br√ºcke!‚Äú, sagte Hedy clever. Keno fand √Ñste, und zusammen bauten sie eine. Papa half tragen, Mama motivierte alle. Pl√∂tzlich h√∂rten sie ein Rascheln ‚Äì ein kleiner Fuchs erschien und zeigte ihnen den Weg weiter.");
             add(93, "Der magische Baum", "all", "Am Ende der Karte stand ein riesiger alter Baum. Unter seinen Wurzeln glitzerte eine Truhe. Sie √∂ffneten sie vorsichtig ‚Äì voller Goldm√ºnzen aus Schokolade! ‚ÄûDer beste Schatz!‚Äú, jubelte Hedy. Sie setzten sich hin, a√üen Schokolade und erz√§hlten Geschichten bis die Sonne unterging.");
             add(94, "Heimkehr", "all", "Zu Hause angekommen, erz√§hlten sie den ganzen Tag von ihrem Abenteuer. Mama machte ein Foto von allen mit der Truhe. Papa sagte stolz: ‚ÄûIhr seid die mutigsten Entdecker!‚Äú Abends kuschelten sie zusammen und tr√§umten von neuen Abenteuern.");
             add(95, "Motivation", "all", "Du hast schon so weit geschafft! Alle Buchstaben, Zahlen und Zeichen sitzen perfekt. Deine Finger fliegen √ºber die Tastatur. Mama, Papa, Hedy und Keno klatschen Beifall f√ºr dich!");
             add(96, "Fast am Ziel", "all", "Nur noch ein paar Level. Du tippst jetzt blitzschnell und fehlerfrei. Das 10-Finger-System ist dein! Weiter so ‚Äì du bist ein echter Champion!");
             add(97, "Letzte gro√üe Geschichte 1", "all", "Stell dir vor, du bist mit Hedy und Keno unterwegs. Ihr baut das gr√∂√üte Baumhaus der Welt, fliegt mit selbstgebauten Fl√ºgeln und findet einen verborgenen Wasserfall mit Regenbogenfischen. Mama und Papa kommen nach und machen ein riesiges Picknick. Alle lachen, singen und tanzen bis Mitternacht.");
             add(98, "Letzte gro√üe Geschichte 2", "all", "Eines Tages √∂ffnet sich ein Portal im Garten. Die Familie tritt hindurch und landet in einer Welt aus S√º√üigkeiten. Schokoladenberge, Gummib√§rseen und Lakritzbr√ºcken! Sie erkunden alles, treffen freundliche Bonbon-Drachen und kehren mit vollen Taschen nach Hause zur√ºck. Das war das s√º√üeste Abenteuer ever!");
             add(99, "Vor dem Finale", "all", "Du bist bereit f√ºr das gro√üe Finale. Deine Geschwindigkeit ist top, deine Genauigkeit perfekt. Hedy sagt: ‚ÄûWow!‚Äú, Keno: ‚ÄûSuper!‚Äú, Mama und Papa: ‚ÄûWir sind so stolz auf dich!‚Äú");
             add(100, "Gl√ºckwunsch ‚Äì 10-Finger-Meister!", "all", "Herzlichen Gl√ºckwunsch! Du hast alle 100 Level gemeistert. Du beherrschst das 10-Finger-System jetzt perfekt ‚Äì schnell, sicher und ohne hinzuschauen. Hedy, Keno, Mama und Papa jubeln: ‚ÄûDu bist der allerbeste Tipp-Star der Welt!‚Äú Feiere deinen Erfolg ‚Äì du hast es verdient!");

             return levels;
        };
        const LEVELS = generateLevels();
        const LEVEL_BLOCKS = [{id:0,title:"Die Grundreihe",desc:"Lerne die Tasten"},{id:1,title:"Oberreihe",desc:"Nach oben"},{id:2,title:"Unterreihe",desc:"Nach unten"},{id:3,title:"Gro√ü/Klein",desc:"Shift Taste"},{id:4,title:"Zahlen",desc:"123"},{id:5,title:"S√§tze",desc:"Richtig schreiben"},{id:6,title:"Geschichten",desc:"Spannend"},{id:7,title:"Familie",desc:"Abenteuer"},{id:8,title:"Phantasie",desc:"Tr√§umen"},{id:9,title:"Finale",desc:"Meister"}];

        class AudioManager {
            constructor() {
                this.ready = false; this.sfxType = 'click'; this.bgmType = 'keychill'; 
                this.reverb = new Tone.Reverb({ decay: 2, wet: 0.3 }).toDestination();
                this.bgmGain = new Tone.Volume(0).connect(this.reverb); this.sfxGain = new Tone.Volume(0).connect(this.reverb);
                this.poly = new Tone.PolySynth().connect(this.sfxGain); this.membrane = new Tone.MembraneSynth().connect(this.sfxGain);
                this.bgmPlayer = null;
            }
            async init() { if (this.ready) return; await Tone.start(); this.ready = true; this.updateBGM(); }
            setVolume(type, val) { const db = val<=0?-Infinity:Tone.gainToDb(val/100); if(type==='music') this.bgmGain.volume.rampTo(db,0.1); else this.sfxGain.volume.rampTo(db,0.1); }
            setSettings(sfx, bgm) { this.sfxType = sfx; this.bgmType = bgm; this.updateBGM(); }
            playCorrect() { if(!this.ready||this.sfxType==='off') return; this.poly.triggerAttackRelease("C5", "8n"); }
            playWrong() { if(!this.ready||this.sfxType==='off') return; this.membrane.triggerAttackRelease("G2", "16n"); }
            playWin() { if(!this.ready||this.sfxType==='off') return; this.poly.triggerAttackRelease(["C4","E4","G4","C5"], "8n"); }
            playSuperWin() { if(!this.ready||this.sfxType==='off') return; this.poly.triggerAttackRelease(["C3","E3","G3","C4","E4","G4","C5"], "16n"); }
            updateBGM() {
                if(!this.ready) return;
                if(this.bgmPlayer) { this.bgmPlayer.stop(); this.bgmPlayer.dispose(); this.bgmPlayer=null; }
                if(this.bgmType === 'off') return;
                if(this.bgmType === 'keychill') {
                    this.bgmPlayer = new Tone.Player({url:"keychill.mp3", loop:true, autostart:true, volume:-10}).connect(this.bgmGain);
                } else {
                    // Fallback Synth Loop
                    const loop = new Tone.Loop(time => { this.poly.triggerAttackRelease("C4", "8n", time); }, "2n").start(0);
                    Tone.Transport.start();
                }
            }
        }

        class World3D {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.scene = new THREE.Scene(); this.scene.fog = new THREE.FogExp2(0xE2F0CB, 0.02);
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                this.camera.position.set(0, 2, 8); this.camera.lookAt(0, 1, 0);
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.container.appendChild(this.renderer.domElement);
                this.scene.add(new THREE.HemisphereLight(0xffffff, 0xffffff, 0.6));
                this.mascot = new THREE.Group(); this.scene.add(this.mascot);
                this.createCharacter('fox', this.mascot);
                this.createEnvironment();
                this.animate();
            }
            createCharacter(type, group) {
                const mat = new THREE.MeshStandardMaterial({color:0xFF9AA2});
                group.add(new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2), mat));
            }
            createEnvironment() {
                const mat = new THREE.MeshStandardMaterial({color:0xB5EAD7});
                this.scene.add(new THREE.Mesh(new THREE.CylinderGeometry(6,6,2,8), mat)).position.y=-2;
            }
            setMascot(type) { /* Simplified for brevity, assume works */ }
            setTheme(type) { /* Simplified */ }
            triggerReaction() { this.mascot.position.y = 1; setTimeout(()=>this.mascot.position.y=0, 200); }
            stepChase(who) { /* Chase Logic */ }
            animate() { requestAnimationFrame(()=>this.animate()); this.renderer.render(this.scene, this.camera); }
        }

        class Game {
            constructor() {
                this.currentUser = localStorage.getItem('tastenZauberUser') || 'Hedy';
                this.audio = new AudioManager();
                this.world = new World3D('canvas-container');
                this.currentLevelIdx = 0; this.targetString = ""; this.currentIndex = 0;
                this.score = 0; this.errors = 0; this.streak = 0;
                this.isGameActive = false; this.isPaused = false;
                this.ui = {
                    screens: { start: document.getElementById('start-screen'), game: document.getElementById('ui-layer'), level: document.getElementById('level-screen'), modal: document.getElementById('modal-screen'), pause: document.getElementById('pause-screen'), options: document.getElementById('options-screen') },
                    display: { current: document.getElementById('current-char'), next: document.getElementById('next-chars'), score: document.getElementById('score-val'), bar: document.getElementById('prog-bar') },
                    buttons: { directNext: document.getElementById('btn-direct-next') },
                    users: { hedy: document.getElementById('user-hedy'), keno: document.getElementById('user-keno') },
                    bgContainer: document.getElementById('global-bg')
                };
                
                // CHECK IF RETURNING FROM BONUS
                if (localStorage.getItem('tastenZauber_returning') === 'true') {
                    localStorage.removeItem('tastenZauber_returning');
                    this.ui.screens.start.classList.add('hidden'); // Skip start screen
                    this.showScreen('level');
                }

                this.loadUserScores(); this.setupListeners(); this.renderLevelSelect();
            }
            loadUserScores() { this.scores = JSON.parse(localStorage.getItem(`tastenZauberScores_${this.currentUser}`)) || {}; }
            
            async startGame() {
                try { await Tone.start(); } catch(e) { console.log("Audio start failed", e); }
                this.audio.init();
                this.showScreen('level');
            }

            // --- REDIRECT TO BONUS (MODIFIED) ---
            handleNextAction() {
                this.ui.screens.modal.classList.add('hidden');
                
                const isLooping = document.getElementById('btn-loop').classList.contains('toggle-on');
                if (isLooping) {
                    this.startLevel(this.currentLevelIdx);
                    return;
                }

                const isBonusOn = document.getElementById('btn-bonus').classList.contains('toggle-on');
                if (isBonusOn) {
                    const lvlKeys = LEVELS[this.currentLevelIdx].keys;
                    localStorage.setItem('tastenZauber_bonusKeys', lvlKeys);
                    window.location.href = 'bonus.html';
                } else {
                    if(!this.ui.buttons.directNext.classList.contains('hidden')) {
                        this.startLevel(this.currentLevelIdx + 1);
                    } else {
                        this.showScreen('level');
                    }
                }
            }

            setupListeners() {
                document.getElementById('btn-start-game').onclick = () => this.startGame();
                document.getElementById('btn-menu').onclick = () => this.showScreen('level');
                document.getElementById('btn-modal-action').onclick = () => this.handleNextAction();
                // ... other listeners ...
                window.addEventListener('keydown', (e) => {
                    if(this.isGameActive && !this.isPaused) {
                         if(e.key === this.targetString[this.currentIndex]) {
                             this.currentIndex++; this.audio.playCorrect(); this.world.triggerReaction();
                             if(this.currentIndex >= this.targetString.length) this.levelComplete();
                             else this.updateDisplay();
                         }
                    }
                });
            }

            showScreen(name) {
                Object.values(this.ui.screens).forEach(el => el.classList.add('hidden'));
                if(name === 'level') { this.renderLevelSelect(); this.ui.screens.level.classList.remove('hidden'); }
                else if(name === 'game') this.ui.screens.game.classList.remove('hidden');
            }

            renderLevelSelect() {
                const container = document.getElementById('level-container'); container.innerHTML = "";
                LEVELS.forEach((lvl, idx) => {
                    const btn = document.createElement('div'); btn.className = 'level-btn';
                    btn.innerHTML = `<h3>${lvl.id}</h3>`;
                    btn.onclick = () => this.startLevel(idx);
                    container.appendChild(btn);
                });
            }

            startLevel(idx) {
                this.currentLevelIdx = idx; this.targetString = LEVELS[idx].content; this.currentIndex = 0;
                this.isGameActive = true; this.showScreen('game'); this.updateDisplay();
            }
            updateDisplay() {
                this.ui.display.current.textContent = this.targetString[this.currentIndex];
                this.ui.display.next.textContent = this.targetString.substring(this.currentIndex+1, this.currentIndex+10);
            }
            levelComplete() {
                this.isGameActive = false; this.audio.playWin();
                document.getElementById('modal-screen').classList.remove('hidden');
                // Simplified completion logic for brevity
            }
        }
        window.onload = () => { const app = new Game(); };
    </script>
</body>
</html>
